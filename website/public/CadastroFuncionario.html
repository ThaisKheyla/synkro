<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synkro | Cadastrar Funcionário</title>
  <link rel="stylesheet" href="./css/dash.css">
  <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro(); carregarEmpresasECargos();">
  <div class="layout-principal">
    <!-- ====== BARRA LATERAL ====== -->
    <aside class="barra-lateral">
      <div class="logo">Synkro</div>

      <div class="perfil-usuario">
        <img src="./assets/imgs/foto_perfil_padrao.webp" alt="Foto de perfil">
        <div class="cargo-usuario">Gerente</div>
        <div class="nome-usuario" id="nome_login"></div>
        <div class="email-usuario" id="email_login"></div>
      </div>

      <nav>
        <ul>
          <li><a href="dashboardGerente.html" class="btn-adicionar-componente">Visão geral</a></li>
          <li><a href="CadastroFuncionario.html" class=" ativo btn-adicionar-componente">Adicionar funcionario</a></li>
        </ul>

        <button class="btn-sair" onclick="limparSessao()">Sair</button>
      </nav>
    </aside>

    <main class="conteudo-principal">
      <section class="painel-hardware">
        <div class="cabecalho-painel">
          <h2>CADASTRAR FUNCIONÁRIO</h2>
        </div>

        <form id="formCadastro" class="form-cadastro">
          <label for="nome">Nome:</label>
          <input type="text" id="nome" placeholder="Digite o nome completo" required>

          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="Digite o email corporativo" required>
          <div class="campo-erro" id="emailError" style="color:#b91c1c; font-size:0.9rem; height:1.2rem;"></div>

          <label for="nascimento">Data de nascimento:</label>
          <input type="date" id="nascimento" required>

          <label for="cpf">CPF:</label>
          <input type="text" id="cpf" maxlength="14" placeholder="000.000.000-00" required oninput="formatarCPF(this)">
          <div class="campo-erro" id="cpfError" style="color:#b91c1c; font-size:0.9rem; height:1.2rem;"></div>

          <label for="cargo">Cargo:</label>
          <select id="cargo" required>
            <option value="">Selecione um cargo</option>
          </select>
          
          <label for="senha">Senha:</label>
          <input type="password" id="senha" placeholder="Crie uma senha" required>

          <label for="confirmar">Confirmar senha:</label>
          <input type="password" id="confirmar" placeholder="Confirme a senha" required>

          <button type="submit" class="btn-cadastrar">CADASTRAR</button>
        </form>
      </section>
    </main>
  </div>

  <script>

    function formatarCPF(input) {
      let valor = input.value.replace(/\D/g, "");
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      input.value = valor;
    }

    async function carregarEmpresasECargos() {
      try {
        const cargosResp = await fetch("/funcionarios/cargos");
        if (!cargosResp.ok) {
          throw new Error(`Resposta inválida: cargos(${cargosResp.status})`);
        }
        const cargos = await cargosResp.json();
        const cargoSelect = document.getElementById("cargo");
        cargoSelect.innerHTML = `<option value="">Selecione um cargo</option>` + cargos.map(c => `<option value="${c.idCargo}">${c.nome}</option>`).join('');
      } catch (err) {
        alert("Erro ao carregar cargos: " + err.message);
        console.error(err);
      }
    }

    document.getElementById("email").addEventListener("input", () => {
      document.getElementById("emailError").textContent = "";
      document.getElementById("email").style.border = "";
    });
    document.getElementById("cpf").addEventListener("input", () => {
      document.getElementById("cpfError").textContent = "";
      document.getElementById("cpf").style.border = "";
    });

    document.getElementById("formCadastro").addEventListener("submit", async (e) => {
      e.preventDefault();

      const senha = document.getElementById("senha").value;
      const confirmar = document.getElementById("confirmar").value;
      const fkEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO")

      if (senha !== confirmar) {
        alert("As senhas não coincidem!");
        return;
      }

      const funcionario = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        dtnascimento: document.getElementById("nascimento").value,
        cpf: document.getElementById("cpf").value,
        senha: senha,
        fkCargo: parseInt(document.getElementById("cargo").value),
        fkEmpresa: fkEmpresa
      };

      try {
        const resp = await fetch("/funcionarios/cadastrar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(funcionario)
        });

        if (resp.ok) {
          alert("✅ Funcionário cadastrado com sucesso!");
          document.getElementById("formCadastro").reset();
        } else {
          // lê corpo do erro (se houver)
          const erro = await resp.json().catch(() => ({}));
          const msg = erro.mensagem || erro.mensagem || resp.statusText || "Erro desconhecido";

          if (resp.status === 409) {
            if (/cpf/i.test(msg)) {
              document.getElementById("cpfError").textContent = msg;
              document.getElementById("cpf").style.border = "2px solid #b91c1c";
              document.getElementById("cpf").focus();
            } else if (/email/i.test(msg)) {
              document.getElementById("emailError").textContent = msg;
              document.getElementById("email").style.border = "2px solid #b91c1c";
              document.getElementById("email").focus();
            } else {
              alert("Erro: " + msg);
            }
          } else {
            alert("Erro: " + msg);
          }
        }
      } catch (err) {
        alert(" Servidor indisponível: " + err.message);
        console.error(err);
      }
    });
  </script>
</body>

</html>
