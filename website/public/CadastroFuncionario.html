<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synkro | Cadastrar Funcionário</title>
  <link rel="stylesheet" href="./css/dash.css">
  <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro(); carregarEmpresasECargos();">
  <div class="layout-principal">
    <!-- ====== BARRA LATERAL ====== -->
    <aside class="barra-lateral">
      <div class="logo">Synkro</div>

      <div class="perfil-usuario">
        <img src="./assets/imgs/foto_perfil_padrao.webp" alt="Foto de perfil">
        <div class="cargo-usuario">Gerente</div>
        <div class="nome-usuario" id="nome_login"></div>
        <div class="email-usuario" id="email_login"></div>
      </div>

      <nav>
        <ul>
          <li><a href="#" class="btn-adicionar-componente">Informações gerais</a></li>
          <li><a href="#" class="btn-adicionar-componente">Informações sobre o mainframe</a></li>
          <li><a href="dashboardGerente.html" class="btn-adicionar-componente">Dashboard</a></li>
        </ul>

        <button class="btn-sair" onclick="limparSessao()">Sair</button>
      </nav>
    </aside>

    <!-- ====== CONTEÚDO PRINCIPAL ====== -->
    <main class="conteudo-principal">
      <section class="painel-hardware">
        <div class="cabecalho-painel">
          <h2>CADASTRAR FUNCIONÁRIO</h2>
        </div>

        <form id="formCadastro" class="form-cadastro">
          <label for="nome">Nome:</label>
          <input type="text" id="nome" placeholder="Digite o nome completo" required>

          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="Digite o email corporativo" required>

          <label for="nascimento">Data de nascimento:</label>
          <input type="date" id="nascimento" required>

          <label for="cpf">CPF:</label>
          <input type="text" id="cpf" maxlength="14" placeholder="000.000.000-00" required oninput="formatarCPF(this)">

          <label for="cargo">Cargo:</label>
          <select id="cargo" required>
            <option value="">Selecione um cargo</option>
          </select>

          <label for="empresa">Empresa:</label>
          <select id="empresa" required>
            <option value="">Selecione uma empresa</option>
          </select>

          <label for="senha">Senha:</label>
          <input type="password" id="senha" placeholder="Crie uma senha" required>

          <label for="confirmar">Confirmar senha:</label>
          <input type="password" id="confirmar" placeholder="Confirme a senha" required>

          <button type="submit" class="btn-cadastrar">CADASTRAR</button>
        </form>
      </section>
    </main>
  </div>

  <script>

    function formatarCPF(input) {
      let valor = input.value.replace(/\D/g, "");
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      input.value = valor;
    }

     function carregarEmpresasECargos() {
      try {
        const [empresas, cargos] =  Promise.all([
          fetch("http://localhost:8000/funcionarios/empresas").then(r => r.json()),
          fetch("http://localhost:8000/funcionarios/cargos").then(r => r.json())
        ]);

        const cargoSelect = document.getElementById("cargo");
        const empresaSelect = document.getElementById("empresa");

        cargoSelect.innerHTML = cargos.map(c => `<option value="${c.idCargo}">${c.nome}</option>`).join('');
        empresaSelect.innerHTML = empresas.map(e => `<option value="${e.id}">${e.nomeEmpresarial}</option>`).join('');
      } catch (err) {
        alert("Erro ao carregar cargos ou empresas: " + err.message);
      }
    }

    // ==============================
    // Submeter Cadastro
    // ==============================
    document.getElementById("formCadastro").addEventListener("submit",  (e) => {
      e.preventDefault();

      const senha = document.getElementById("senha").value;
      const confirmar = document.getElementById("confirmar").value;

      if (senha !== confirmar) {
        alert("As senhas não coincidem!");
        return;
      }

      const funcionario = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        dtnascimento: document.getElementById("nascimento").value,
        cpf: document.getElementById("cpf").value,
        senha: senha,
        fkCargo: parseInt(document.getElementById("cargo").value),
        fkEmpresa: parseInt(document.getElementById("empresa").value)
      };

      try {
        const resp =  fetch("http://localhost:3000/funcionarios", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(funcionario)
        });

        if (resp.ok) {
          alert("✅ Funcionário cadastrado com sucesso!");
          document.getElementById("formCadastro").reset();
        } else {
          const erro =  resp.json();
          alert("❌ Erro: " + (erro.mensagem || resp.statusText));
        }
      } catch (err) {
        alert("⚠️ Servidor indisponível: " + err.message);
      }
    });
  </script>
</body>

</html>
