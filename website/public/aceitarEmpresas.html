<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprovação de Empresas - Synkro</title>
    <link rel="stylesheet" href="css/aceitar.css">
    <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro()">
    <div class="layout-principal">
        <!--Barra lateral -->
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/foto_perfil_padrao.webp" alt="Foto de perfil">
                <div class="nome-usuario" id="nome_login"></div>
                <div class="email-usuario" id="email_login"></div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li><a href="aceitarEmpresas.html" class="ativo">Aprovações</a></li>
                    <li><a href="detalhesEmpresa.html">Ver detalhes</a></li>
                </ul>


                <button class="btn-sair" onclick="limparSessao()">Sair</button>
            </nav>
        </aside>

        <main class="conteudo-principal">
            <section class="painel-hardware">

                <div class="cabecalho-painel">

                    <h2>Aprovação de Empresas</h2>
                    <div class="data_atual">
                        <p>Data de hoje: </p>
                        <span id="dataHeader"></span>
                        <img id="agenda_icon" src="./assets/imgs/icon_agenda.jpg" alt=""
                            style="height:32px; border-radius:8px;">
                    </div>
                </div>
                <div class="cartoes-resumo" style="margin-bottom: 24px;">
                    <div class="cartao-resumo">
                        <div class="info-pagina">
                            <p class="info-texto">
                                Nesta página você pode visualizar todas as empresas cadastradas no sistema.
                                Utilize o filtro para separar empresas pendentes, aprovadas ou reprovadas.
                                Lembre-se: apenas empresas aprovadas terão acesso aos nossos serviços.
                            </p>
                        </div>
                        <div class="rotulo">Filtro</div>
                        <select onchange="criarCards()" id="filtro" class="filtro">
                            <option value="1,2,3">Todas as empresas</option>
                            <option value="1">Pendentes</option>
                            <option value="2">Reprovadas</option>
                            <option value="3">Aprovadas</option>
                        </select>
                    </div>
                </div>
                <div class="graficos-row">
                    <div class="grafico-box" style="width:100%; min-width:320px; border-radius: 12px;">
                        <h4>Empresas</h4>

                        <div class="tabela-aprovacoes" style="overflow-x:auto;">
                            <div class="nota-tabela">
                                <p class="info-texto">
                                    Utilize os botões de ação para aprovar ou reprovar empresas individualmente.
                                    Empresas aprovadas poderão acessar o sistema imediatamente.
                                </p>
                            </div>
                            <table id="tabela_empresas"></table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- VLibras -->
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>

</body>

<script>
    document.getElementById('dataHeader').textContent = new Date().toLocaleDateString();

    var id = []
    var nomeEmpresarial = []
    var nomeRepresentante = []
    var statusOperacao = []
    var statusAcesso = []

    function criarCards() {
        var filtroVar = filtro.value;
        tabela_empresas.innerHTML = `
                <tr class="header_table">
                    <th class="id_table">ID</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>ISPB</th>
                    <th>Status Op.</th>
                    <th class="acao_table">Ação</th>
                </tr>
            `
        fetch("/aceitarEmpresas/buscarCards", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                filtroServer: filtroVar,
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    id = []
                    nomeEmpresarial = []
                    nomeRepresentante = []
                    statusOperacao = []
                    statusAcesso = []
                    email = []
                    ispb = []
                    for (i = 0; i < json.length; i++) {
                        id.push(json[i].id);
                        nomeEmpresarial.push(json[i].nomeEmpresarial);
                        email.push(json[i].email)
                        nomeRepresentante.push(json[i].nomeRepresentante);
                        ispb.push(json[i].ispb);
                        statusOperacao.push(json[i].statusOperacao);
                        statusAcesso.push(json[i].statusAcesso);
                    }
                    var status = ''
                    var corTexto = ""
                    for (i = 0; i < id.length; i++) {
                        if (statusAcesso[i] == 1) {
                            status = 'Pendente'
                            corTexto = `gray`
                        }
                        if (statusAcesso[i] == 2) {
                            status = 'Reprovada'
                            corTexto = "red"
                        }
                        if (statusAcesso[i] == 3) {
                            status = 'Aprovada'
                            corTexto = "green"
                        }
                        tabela_empresas.innerHTML += `
                                <tr>
                                    <td class="id_table">${id[i]}</td>
                                    <td>${nomeEmpresarial[i]}</td>
                                    <td>${email[i]}</td>
                                    <td>${ispb[i]}</td>
                                    <td style ="color:${corTexto};font-weight:500">${status}</td>
                                    <td class="acao_table">
                                        ${status != 'Aprovada' ? `<button style="background-color: 	rgb(30,144,255)" onclick="aprovar(${i})"id=aprovar${i}>Aprovar</button>` : ""}
                                        ${status != 'Reprovada' ? `<button style="background-color:  #ff4040" onclick="reprovar(${i})"id=reprovar${i}>Reprovar</button>` : ""}
                                    </td>
                                </tr>`
                    }
                });
            }
        })
        return false;
    }
    criarCards()
    function aprovar(i) {
        var idEmpresa1 = id[i]
        editar(idEmpresa1, 3)
    }
    function reprovar(i) {
        var idEmpresa2 = id[i]
        editar(idEmpresa2, 2)
    }
    function editar(idEmpresaPassado, novoStatusPassado) {
        fetch(`/aceitarEmpresas/statusEmpresa`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                novoStatus: novoStatusPassado,
                idEmpresa: idEmpresaPassado
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                window.alert("Situação de empresa atualizada com sucesso!");
                window.location = "aceitarEmpresas.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }
</script>

</html>