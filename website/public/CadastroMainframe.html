<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synkro | Cadastrar Mainframe</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/dash.css">
  <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro(); carregarSelects();">
  <div class="layout-principal">
    <!-- ====== BARRA LATERAL ====== -->
    <aside class="barra-lateral">
      <div class="logo">
        Synkro
      </div>
      <div class="perfil-usuario">
        <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
        <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
        <div class="cargo-usuario">
          <i class="ri-shield-user-line"></i>
          Analista de Infra
        </div>
        <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
      </div>
      <nav>
        <ul class="menu-links">
          <li>
            <a href="dashboardAnalista.html">
              <i class="ri-dashboard-3-line"></i>
              Visão Geral
            </a>
          </li>
          <li>
            <a href="CadastroMainframe.html" class="ativo">
              <i class="ri-file-add-line icon-cadastro"></i>
              Cadastrar Mainframes
            </a>
          </li>
          <li>
            <a href="dashMainframes.html">
              <i class="ri-database-2-line"></i>
              Mainframes
            </a>
          </li>
        </ul>
        <button class="btn-sair" onclick="limparSessao()">
          <i class="ri-logout-box-r-line"></i>
          Encerrar Sessão
        </button>
      </nav>
    </aside>

    <!-- ====== CONTEÚDO PRINCIPAL ====== -->
    <main class="conteudo-principal">
      <section class="painel-hardware">
        <div class="cabecalho-painel">
          <h2>CADASTRAR MAINFRAME</h2>
        </div>

        <form id="formMainframe" class="form-cadastro">
          <label for="fabricante">Fabricante:</label>
          <input type="text" id="fabricante" placeholder="Digite o fabricante" required>

          <label for="modelo">Modelo:</label>
          <input type="text" id="modelo" placeholder="Digite o modelo" required>

          <label for="mac">MAC Address:</label>
          <input type="text" id="mac" placeholder="Ex: 00:1B:44:11:3A:B7" required>

          <label for="setor">Setor:</label>
          <div class="inline-field">
            <select id="setor" required>
              <option value="">Selecione o setor</option>
            </select>
            <button type="button" class="btn-pequeno" id="toggleAddSetor">+</button>
          </div>
          <div class="inline-add oculto" id="addSetorBox">
            <input type="text" id="novoSetor" placeholder="Novo setor">
            <button type="button" class="btn-pequeno" id="salvarSetor">Salvar</button>
            <button type="button" class="btn-pequeno" id="cancelSetor">Cancelar</button>
          </div>

          <label for="sistema">Sistema Operacional:</label>
          <div class="inline-field">
            <select id="sistema" required>
              <option value="">Selecione o sistema</option>
            </select>
            <button type="button" class="btn-pequeno" id="toggleAddSistema">+</button>
          </div>
          <div class="inline-add oculto" id="addSistemaBox">
            <input type="text" id="novoSistema" placeholder="Novo sistema operacional">
            <button type="button" class="btn-pequeno" id="salvarSistema">Salvar</button>
            <button type="button" class="btn-pequeno" id="cancelSistema">Cancelar</button>
          </div>

          <div class="config-container">
            <button type="button" id="btnConfig" class="btn-config">+ Configurações de Métricas</button>
          </div>

          <!-- Área dinâmica de métricas -->
          <div id="configuracoes" class="configuracoes oculto">
            <h3>Configurações de Métricas</h3>
            <div id="metricasContainer"></div>

            <button type="button" id="btnAddMetrica" class="btn-cadastrar"
              style="background: var(--azul-medio); box-shadow: 0 1px 2px var(--branco);">
              + Adicionar Métrica
            </button>
          </div>

          <button type="submit" class="btn-cadastrar">CADASTRAR MAINFRAME</button>
        </form>
      </section>


    </main>
    <aside class="mainframes-cadastrados">
      <h4>Mainframes Cadastrados</h4>
      <div id="listaMainframes"></div>
    </aside>

    <script>
      const btnConfig = document.getElementById("btnConfig");
      const boxConfig = document.getElementById("configuracoes");
      const metricasContainer = document.getElementById("metricasContainer");
      const btnAddMetrica = document.getElementById("btnAddMetrica");
      const formMainframe = document.getElementById("formMainframe");

      // Mostrar/ocultar configurações
      btnConfig.addEventListener("click", () => {
        boxConfig.classList.toggle("oculto");
      });

      // Criação de bloco de métrica
      function criarMetrica(componentes, tipos) {
        const div = document.createElement("div");
        div.classList.add("bloco-metrica");
        div.innerHTML = `
        <div class="configuracoes-metricas">
          <label>Componente:</label>
          <select class="componente">
            ${componentes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
          </select>
          <button type="button" class="btn-pequeno toggle-add-componente">+</button>
        </div>

        <div class="configuracoes-metricas">
          <label>Tipo de Métrica:</label>
          <select class="tipo">
            ${tipos.map(t => `<option value="${t.id}">${t.descricao}</option>`).join('')}
          </select>
          <button type="button" class="btn-pequeno toggle-add-tipo">+</button>
        </div>

        <div class="configuracoes-metricas">
          <label>Valor Mínimo:</label>
          <input type="number" step="0.1" class="min" placeholder="Ex: 0">
        </div>

        <div class="configuracoes-metricas">
          <label>Valor Máximo:</label>
          <input type="number" step="0.1" class="max" placeholder="Ex: 100">
        </div>

        <button type="button" class="btn-remover">Remover</button>
        <hr>
      `;
        div.querySelector(".btn-remover").addEventListener("click", () => div.remove());
        metricasContainer.appendChild(div);

        // permitir adicionar componente/tipo direto do bloco (abre inputs temporários)
        div.querySelector(".toggle-add-componente").addEventListener("click", () => {
          const inp = document.createElement("input");
          inp.placeholder = "Novo componente";
          const save = document.createElement("button");
          save.textContent = "Salvar";
          save.type = "button";
          save.className = "btn-pequeno";
          save.addEventListener("click", async () => {
            const nome = inp.value.trim();
            if (!nome) return alert("Digite o nome do componente.");
            await adicionarSimples("/mainframes/componentes", { nome });
            await carregarSelects(); // recarrega todas as listas
          });
          div.querySelector(".configuracoes-metricas").appendChild(inp);
          div.querySelector(".configuracoes-metricas").appendChild(save);
        });

        div.querySelector(".toggle-add-tipo").addEventListener("click", () => {
          const inp = document.createElement("input");
          inp.placeholder = "Nova descrição de tipo";
          const save = document.createElement("button");
          save.textContent = "Salvar";
          save.type = "button";
          save.className = "btn-pequeno";
          save.addEventListener("click", async () => {
            const descricao = inp.value.trim();
            if (!descricao) return alert("Digite a descrição do tipo.");
            await adicionarSimples("/mainframes/tipos", { descricao });
            await carregarSelects();
          });
          div.querySelectorAll(".configuracoes-metricas")[1].appendChild(inp);
          div.querySelectorAll(".configuracoes-metricas")[1].appendChild(save);
        });
      }

      // Função genérica para adicionar entidade simples via POST
      async function adicionarSimples(url, body) {
        try {
          const resp = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          if (!resp.ok) {
            const erro = await resp.json().catch(() => ({}));
            throw new Error(erro.erro || resp.statusText);
          }
          return true;
        } catch (err) {
          alert("Erro ao salvar: " + err.message);
          return false;
        }
      }

      // Carregar selects de setor, sistema, componente e tipo
      async function carregarSelects() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
        try {
          const [setoresResp, sistemasResp, componentesResp, tiposResp] = await Promise.all([
            fetch(`/mainframes/setores/${idEmpresa}`),
            fetch("/mainframes/sistemas"),
            fetch("/mainframes/componentes"),
            fetch("/mainframes/tipos")
          ]);

          if (![setoresResp, sistemasResp, componentesResp, tiposResp].every(r => r.ok)) {
            throw new Error("Erro ao carregar dados iniciais");
          }

          const [setores, sistemas, componentes, tipos] = await Promise.all([
            setoresResp.json(),
            sistemasResp.json(),
            componentesResp.json(),
            tiposResp.json()
          ]);

          const setorSelect = document.getElementById("setor");
          const sistemaSelect = document.getElementById("sistema");

          setorSelect.innerHTML = `<option value="">Selecione o setor</option>` +
            setores.map(s => `<option value="${s.id}">${s.nome} (${s.localizacao})</option>`).join('');

          sistemaSelect.innerHTML = `<option value="">Selecione o sistema</option>` +
            sistemas.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');

          // prevent multiple handlers when called repeatedly
          btnAddMetrica.replaceWith(btnAddMetrica.cloneNode(true));
          const newBtnAdd = document.getElementById("btnAddMetrica");
          newBtnAdd.addEventListener("click", () => criarMetrica(componentes, tipos));

          // atualizar event listeners para adição inline dos selects principais
          document.getElementById("toggleAddSetor").addEventListener("click", () => {
            document.getElementById("addSetorBox").classList.toggle("oculto");
          });
          document.getElementById("cancelSetor").addEventListener("click", () => {
            document.getElementById("novoSetor").value = "";
            document.getElementById("addSetorBox").classList.add("oculto");
          });
          document.getElementById("salvarSetor").addEventListener("click", async () => {
            const nome = document.getElementById("novoSetor").value.trim();
            if (!nome) return alert("Digite o nome do setor.");
            const ok = await adicionarSimples("/mainframes/setores", { nome });
            if (ok) {
              document.getElementById("novoSetor").value = "";
              document.getElementById("addSetorBox").classList.add("oculto");
              await carregarSelects();
            }
          });

          document.getElementById("toggleAddSistema").addEventListener("click", () => {
            document.getElementById("addSistemaBox").classList.toggle("oculto");
          });
          document.getElementById("cancelSistema").addEventListener("click", () => {
            document.getElementById("novoSistema").value = "";
            document.getElementById("addSistemaBox").classList.add("oculto");
          });
          document.getElementById("salvarSistema").addEventListener("click", async () => {
            const nome = document.getElementById("novoSistema").value.trim();
            if (!nome) return alert("Digite o nome do sistema.");
            const ok = await adicionarSimples("/mainframes/sistemas", { nome });
            if (ok) {
              document.getElementById("novoSistema").value = "";
              document.getElementById("addSistemaBox").classList.add("oculto");
              await carregarSelects();
            }
          });

          carregarMainframes();
        } catch (err) {
          alert("Erro ao carregar dados: " + err.message);
        }
      }

      document.getElementById("formMainframe").addEventListener("submit", async (e) => {
        e.preventDefault();

        const fkEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        if (!fkEmpresa) {
          alert("Erro: Empresa não encontrada na sessão. Faça login novamente.");
          return;
        }

        const mainframe = {
          fabricante: document.getElementById("fabricante").value,
          modelo: document.getElementById("modelo").value,
          mac: document.getElementById("mac").value,
          setor: document.getElementById("setor").value,
          sistema: document.getElementById("sistema").value,
          fkEmpresa: parseInt(fkEmpresa),
          metricas: []
        };

        document.querySelectorAll(".bloco-metrica").forEach((b) => {
          mainframe.metricas.push({
            fkComponente: parseInt(b.querySelector(".componente").value),
            fkTipo: parseInt(b.querySelector(".tipo").value),
            min: parseFloat(b.querySelector(".min").value || 0),
            max: parseFloat(b.querySelector(".max").value || 100)
          });
        });

        try {
          const resp = await fetch("/mainframes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mainframe)
          });

          if (resp.ok) {
            alert("✅ Mainframe cadastrado com sucesso!");
            document.getElementById("formMainframe").reset();
            metricasContainer.innerHTML = "";
            carregarMainframes();
          } else {
            const erro = await resp.json().catch(() => ({}));
            alert("❌ Erro: " + (erro.mensagem || resp.statusText));
          }
        } catch (err) {
          alert("⚠️ Servidor indisponível: " + err.message);
        }
      });

      // Listar mainframes da empresa logada
      async function carregarMainframes() {
        try {
          const fkEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
          const lista = await fetch(`/mainframes/empresa/${fkEmpresa}`).then(r => r.json());
          const container = document.getElementById("listaMainframes");
          container.innerHTML = lista.map(m => `

          <a href="detalhesMainframe.html" class="página de mainframe">
          <div class="mainframe-evento offline">
              <div class="mainframe-numero">${m.id}</div>
              <div class="mainframe-desc">${m.fabricante} ${m.modelo}</div>
          </div>
          </a>
        `).join('');
        } catch (err) {
          console.warn("Erro ao listar mainframes:", err);
        }
      }
    </script>
</body>

</html>