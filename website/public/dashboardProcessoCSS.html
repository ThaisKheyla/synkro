<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/dashboardProcesso.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="./js/sessao.js"></script> -->
    <script>
        var dadosfiltrados = []
        var dadoscru = []
        var processosjson = []
        var horarioformatado = []
        let selecionadoindex = 0;
        //tipo da metrica se ela é cpu ou ram
        let tipometrica="uso_cpu_total_perc"
        // let macAdress=localStorage.getItem('mainframe_macadress')//storage salvo na tela detalhes mainframe
        let macAdress=166250251803552

        async function carregar() {
            try { 
                const res = await fetch(`/csv/dadoscsv/dashboardprocesso.csv/${macAdress}`)
                console.log(res )
                // const res = await fetch('http://localhost:8080/csv/processo/166250251803552');//
                if (!res.ok) throw new Error('Erro ao buscar dados');
                dadosfiltrados = await res.json();
                //datares=filtrardados(dadoscru);
                selecionadoindex = dadosfiltrados.length - 1

                formatarHorario();
                grafico();
                listaprocesso();

            } catch (erro) {
                console.error(erro);
            }
        }
        //seleciona o index do gráfico


        window.addEventListener('load', () => {
            // validarSessaoSynkro();
            carregar();
            document.getElementById('dataHeader').textContent = new Date().toLocaleDateString();
        });

        function filtrardados(dados) {
            // data = dados[dados.length - 1].timestamp;
            // const dateObj = new Date(data.replace(" ", "T"));

            // const hora = String(dateObj.getHours()).padStart(2, "0");
            // const minuto = String(dateObj.getMinutes()).padStart(2, "0");

            //horaminuto = hora + ":" + minuto
            const dadofiltrado = dados.filter(item => {
                const dateObj = new Date(item.timestamp.replace(" ", "T"));

                const hora = String(dateObj.getHours()).padStart(2, "0");
                const minuto = String(dateObj.getMinutes()).padStart(2, "0");

                return minuto % 5 === 0;
            });
            return dadofiltrado
        }

    </script>
</head>

<body onload="carregar()">
    <div class="layout-principal">
        <aside class="barra-lateral">
            <div class="logo">
                Synkro
            </div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Analista de Infra
                </div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li>
                        <a href="dashboardAnalista.html">
                            <i class="ri-dashboard-3-line"></i>
                            Visão Geral
                        </a>
                    </li>
                    <li>
                        <a href="CadastroMainframe.html">
                            <i class="ri-file-add-line icon-cadastro"></i>
                            Cadastrar Mainframes
                        </a>
                    </li>
                    <li>
                        <a href="dashMainframes.html" class="ativo">
                            <i class="ri-database-2-line"></i>
                            Mainframes
                        </a>
                    </li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()">
                    <i class="ri-logout-box-r-line"></i>
                    Encerrar Sessão
                </button>
            </nav>
        </aside>

        <main class="conteudo-dashboard-processo" role="main"
            aria-label="Painel Principal de Monitoramento em Tempo Real do Mainframe">

            <h3 class="section-title" title="Visão geral e desempenho do sistema em tempo real.">Monitoramento de
                recursos e processos</h3>
 
            <div class="col">

                <div class="grafico-box" aria-label="Gráfico Histórico de Métricas do Mainframe">
                    <p class="legenda-graficos"
                        style="font-style: italic; color: #ffffff; margin-bottom: 2px; font-size: 12px;">
                        Selecione uma métrica abaixo para visualizar o histórico de uso detalhado e a evolução do
                        desempenho.
                    </p>

                    <div class="grupo-botoes" role="tablist" aria-label="Seleção de Gráfico">
                        <button class="botao-nav ativo" id="btnCPU" onclick="grafico()"
                            title="Visualizar o gráfico de uso da CPU ao longo do tempo" role="tab"
                            aria-selected="true" style="color: white;">CPU</button>
                        <button class="botao-nav" id="btnRAM" onclick="grafico2()"
                            title="Visualizar o gráfico de consumo de memória RAM ao longo do tempo" role="tab"
                            aria-selected="false" style="color: white;">RAM</button>

                    </div>

                    <h4 id="titulo-grafico" title="Métrica atualmente exibida no gráfico"><i class="ri-cpu-line"></i>
                        CPU - Uso em Tempo Real (Gráfico Histórico)</h4>

                    <div class="grafico-info" id="graficoInfo"
                        title="Métrica atual e variação em relação ao dia anterior">
                        <div class="grafico-metrica">
                            <span class="value" id="graficoValor" aria-live="polite"></span>
                            <span class="label" id="graficoTexto" style="color: white;">Captura Atual</span>
                        </div>
                    </div>
                    <p class="legenda-grafico-container" style="font-size: 0.85rem; color: #ffffff; margin-top: 10px;">
                        O gráfico apresenta dados coletados a cada 5 minutos, cobrindo o período das última
                        hora.
                    </p>
                    <canvas id="myChart" aria-label="Gráfico de linha Histórico da Métrica Selecionada"></canvas>

                </div>
                <div class="direitacol">

                    <div id="processo"></div>
                    <div class="locomover">
                        <div class="esquerda">

                            <button onclick="esquerdaFluxo()"><<</button>
                            <button onclick="esquerdaMark()"><</button>
                        </div> 
                        <div id="horario">00:00</div>
                        <div class="direita">

                            <button onclick="direitaMark()">></button>
                            <button onclick="direitaFluxo()">>></button>
                        </div>
    
                    </div>
                </div>
            </div>
    </div>
    </main>

    </div>
    <script>


        // --- Inicialização na Carga da Página ---
        window.onload = function () {
            if (typeof validarSessaoSynkro === 'function') {
                validarSessaoSynkro();
            }
            setTimeout(() => {
                loadMainframeDetails(currentMainframeId);
            }, 100);

            // setInterval(updateChartData, 3000);
        };


    </script>


    <script src="js/dashboardProcesso.js"></script>

</body>

</html>