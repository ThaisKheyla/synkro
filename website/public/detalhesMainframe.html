<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/detalhesMainframe.css">
    <link rel="stylesheet" href="./css/componentes/kpis.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro()">
    <div class="layout-principal">
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>

            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Analista de Infra
                </div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>

            <nav>
                <ul class="menu-links">
                    <li><a href="dashboardAnalista.html"><i class="ri-dashboard-3-line"></i>Visão Geral</a></li>
                    <li><a href="CadastroMainframe.html"><i class="ri-file-add-line icon-cadastro"></i>Cadastrar
                            Mainframes</a></li>
                    <li><a href="dashMainframes.html" class="ativo"><i class="ri-database-2-line"></i>Mainframes</a>
                    </li>
                </ul>

                <button class="btn-sair" onclick="limparSessao()">
                    <i class="ri-logout-box-r-line"></i> Encerrar Sessão
                </button>
            </nav>
        </aside>

        <main class="conteudo-dashboard" role="main">

            <div class="graficos">
                <div class="grafico-box">
                    <h3 class="section-title">Métricas gerais do mainframe  <span id="mainfrane-title"></span></h3>

                    <div class="kpis-linha">

                        <div class="kpi-card kpi-cpu">
                            <div class="kpi-icone"><i class="ri-cpu-line"></i></div>
                            <div class="kpi-info">
                                <div class="subtitleKpi">
                                    <div id="cpuAlert" class="kpi-titulo">CPU</div>
                                    <div id="cpuAlertN" class="kpi-valor"></div>

                                </div>
                                <div class="kpi-desc">CPU em uso</div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-ram">
                            <div class="kpi-icone"><i class="ri-database-2-line"></i></div>
                            <div class="kpi-info">
                                <div class="subtitleKpi">
                                    <div id="ramAlert" class="kpi-titulo">RAM</div>
                                    <div id="ramAlertN" class="kpi-valor"></div>
                                </div>
                                <div class="kpi-desc">Memória em Uso</div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-disk" onclick="window.location.href='dashkeyla.html'">
                            <div class="kpi-icone"><i class="ri-hard-drive-2-line"></i></div>
                            <div class="kpi-info">
                                <div class="subtitleKpi-disk">
                                    <div id="diskAlert" class="kpi-titulo">DISCO</div>
                                    <div id="diskAlertN" class="kpi-valor"></div>
                                </div>
                                <div class="kpi-desc">Armazenamento Utilizado</div>
                            </div>
                        </div>

                        <div onclick="window.location.href='dashboardProcessoCSS.html'" class="kpi-card kpi-info">
                            <div class="kpi-icone"><i class="ri-align-left"></i></div>
                            <div class="kpi-info">Processos</div>
                        </div>

                        <div class="kpi-card kpi-info" id="openModalBtn">
                            <div class="kpi-icone"><i class="ri-information-fill"></i></div>
                            <div class="kpi-info">Informações</div>
                        </div>
                    </div>

                    <p class="legenda-grafico-container">
                        Gráfico das ultimas (5)métricas
                    </p>

                    <div class="grafico-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="kpis-linha-2">



                        <div class="kpi-card kpi-cpu">
                            <div class="kpi-icone"><i class="ri-cpu-line"></i></div>
                            <div class="kpi-info">
                                <div class="kpi-titulo">Última Variação da CPU</div>
                                <div id="cpuValue" class="kpi-valor"></div>
                                <div class="kpi-desc"></div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-ram">
                            <div class="kpi-icone"><i class="ri-database-2-line"></i></div>
                            <div class="kpi-info">
                                <div class="kpi-titulo">Última Variação da RAM</div>
                                <div id="ramValue" class="kpi-valor"></div>
                                <div class="kpi-desc"></div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-disk-2">
                            <div class="kpi-icone"><i class="ri-hard-drive-2-line"></i></div>
                            <div class="kpi-info">
                                <div class="kpi-titulo">Última Variação da DISCO</div>
                                <div id="diskValue" class="kpi-valor"></div>
                                <div class="kpi-desc"></div>
                            </div>
                        </div>



                    </div>
                </div>
            </div>
            <div></div>
        </main>

        <aside class="mainframes-cadastrados">
            <h4>Mainframes Cadastrados</h4>
            <div id="mainframes-cad"></div>
        </aside>

        <div id="modalOverlay" class="modal-overlay">
            <div>
                <div class="mainframe-detalhes">

                    <h3 class="mf-titulo">
                        <i class="ri-server-line mf-titulo-icone"></i>
                        Detalhes da Unidade do Mainframe
                        <span id="mfNome" class="mf-nome">Mainframe A</span>
                    </h3>

                    <div class="mf-cards">
                        <div class="mf-card">
                            <span class="extra-titulo">MacAdress</span>
                            <span class="extra-valor" id="kpiTempValor">22:22:22:22</span>
                            <span class="extra-desc" id="kpiTempDesc">Idenficador Mainframe</span>
                        </div>
                        <div class="mf-card">
                            <span class="mf-card-titulo">latência read/Write disco</span>
                            <span class="mf-card-valor" id="mfLatencia"></span>
                        </div>
                         <div class="mf-card">
                            <span class="mf-card-titulo"> IOPS disco</span>
                            <span class="mf-card-valor" id="mfUltIops"></span>
                        </div>
                            <div class="mf-card">
                            <span class="extra-titulo">Throughput Disco</span>
                            <span class="extra-valor" id="kpiRedeValor"></span>
                            <span class="extra-desc" id="kpiRedeDesc"></span>
                        </div>
                         <div class="mf-card">
                            <span class="mf-card-titulo">Último Evento de Alerta</span>
                            <span class="mf-card-valor" id="mfUltIncidencia"></span>
                        </div>
                        <div class="mf-card">
                            <span class="extra-titulo">Incidentes (Últimas 24h)</span>
                            <span class="extra-valor" id="kpiEventosValor"></span>
                            <span class="extra-desc" id="kpiEventosDesc">Alertas</span>
                        </div>
                    </div>
                    <button id="closeModalBtn" class="close-btn">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <script>

        var mainframesData

        let MAX_DATA_POINTS = 10;
        let currentMainframeId = 0;
        let mainChart;

        let metricaCpu
        let metricaRam
        let metricaDisk


        function sinal(a, b) {
            const diferenca = (a - b).toFixed(1);
            return (diferenca > 0 ? "+" : "") + diferenca + "%";
        }

        function setMainframe(id){
            sessionStorage.MAINFRAME = id
        }

        async function buscarJsonS3() {
            const resposta = await fetch(`/s3Route/dados/detalhesMainframe.json`);
            const data = await resposta.json();

            const empresaId = sessionStorage.ID_EMPRESA_USUARIO

            const empresa = data.find(item => item.empresa == empresaId);

            if (!empresa) {
                console.error("Nenhum mainframe encontrado para esta empresa");
                return;
            }

            mainframesData = {};

            empresa.mainframes.forEach((mf, index) => {

                // Pegar limites das métricas
                metricaCpu = Number(mf.metricas[1]);
                metricaRam = Number(mf.metricas[4]);
                metricaDisk = Number(mf.metricas[7]);

                mainframesData[index] = {
                    nome: `${mf.Fabricante} ${mf.modelo}`,
                    cpu: mf.cpu,
                    ram: mf.ram,
                    disk: mf.disk,
                    eventos: mf.eventos,
                    mac: mf.mac,
                    rede: [mf.throughput, "throughput"],
                    tempoAlerta: mf.tempoAlerta,
                    metricas: mf.metricas,
                    latencia: mf.latencia,
                    iops: mf.iops

                };
            });

            console.log("Convertido:", mainframesData);
        }

        function renderMainframesList() {
            const container = document.getElementById("mainframes-cad");
            container.innerHTML = "";

            Object.keys(mainframesData).forEach(id => {
                container.innerHTML += `
        <a href="#" onclick="loadMainframeDetails(${id})">
            <div id="mainF${id}" class="mainframe-evento">
                <div class="mainframe-numero">${(parseInt(id) + 1)}</div>
                <div class="mainframe-desc">${mainframesData[id].nome}</div>
            </div>
        </a>`;
            });
        }

        function updateMainframeDetails(id) {
            const mf = mainframesData[id];

            document.getElementById('mfNome').textContent = mf.nome + `  ( ${id + 1} )`;

            document.getElementById('kpiTempValor').textContent = mf.mac;
            document.getElementById('kpiTempDesc').textContent = "Identificador Mainframe"
            document.getElementById('kpiRedeValor').textContent = mf.rede[0] + " mb/s"
            document.getElementById("mfUltIncidencia").textContent = mf.tempoAlerta
            document.getElementById("mfLatencia").textContent = mf.latencia + " ms"
            document.getElementById("mfUltIops").textContent = mf.iops
            metricaCpu = mf.metricas[1]
            metricaRam = mf.metricas[4]
            metricaDisk = mf.metricas[7]


            document.getElementById('kpiEventosValor').textContent = mf.eventos;
            document.getElementById('kpiEventosDesc').textContent = "Últimas 24h"

            document.getElementById('cpuValue').textContent = sinal(mf.cpu[4], mf.cpu[3])
            document.getElementById('ramValue').textContent = sinal(mf.ram[4], mf.ram[3])
            document.getElementById('diskValue').textContent = sinal(mf.disk[4], mf.disk[3])
        }

        function resetKpis() {
            const cpuCard = document.querySelector(".kpi-card.kpi-cpu")
            cpuCard.classList.remove("border-red", "border-orange", "border-null")
            document.getElementById('cpuAlert').className = "kpi-valor"
            document.getElementById('cpuAlertN').className = "kpi-valor"
            document.getElementById('cpuValue').classList.remove("txt-green", "txt-red")

            const ramCard = document.querySelector(".kpi-card.kpi-ram")
            ramCard.classList.remove("border-red", "border-orange", "border-null")
            document.getElementById('ramAlert').className = "kpi-valor"
            document.getElementById('ramAlertN').className = "kpi-valor"
            document.getElementById('ramValue').classList.remove("txt-green", "txt-red")

            const diskCard = document.querySelector(".kpi-card.kpi-disk");
            diskCard.classList.remove("border-red", "border-orange", "border-null");
            document.getElementById('diskAlert').className = "kpi-valor";
            document.getElementById('diskAlertN').className = "kpi-valor";
            document.getElementById('diskValue').classList.remove("txt-green", "txt-red");
        }

        function updateMainKpis(id) {
            resetKpis()
            const mf = mainframesData[id];

            document.getElementById('cpuAlertN').textContent = mf.cpu[mf.cpu.length - 1] + "%"
            document.getElementById('ramAlertN').textContent = mf.ram[mf.ram.length - 1] + "%"
            document.getElementById('diskAlertN').textContent = mf.disk[mf.disk.length - 1] + "%"

            document.getElementById('cpuValue').textContent = sinal(mf.cpu[4], mf.cpu[3])
            document.getElementById('cpuValue').classList.add((mf.cpu[4] - mf.cpu[3] <= 0) ? "txt-green" : "txt-red")
            document.getElementById('ramValue').textContent = sinal(mf.ram[4], mf.ram[3])
            document.getElementById('ramValue').classList.add((mf.ram[4] - mf.ram[3] <= 0) ? "txt-green" : "txt-red")
            document.getElementById('diskValue').textContent = sinal(mf.disk[4], mf.disk[3])
            document.getElementById('diskValue').classList.add((mf.disk[4] - mf.disk[3] <= 0) ? "txt-green" : "txt-red")

            if (mf.cpu[4] >= metricaCpu) {
                document.getElementById('cpuAlert').className = ("kpi-valor-alert-2");
                document.getElementById('cpuAlertN').className = ("kpi-valor-alert-2");
                document.querySelector(".kpi-card.kpi-cpu").classList.add("border-red");
            } else if (mf.cpu[4] >= (metricaCpu * 0.80)) {
                document.getElementById('cpuAlert').className = ("kpi-valor-alert-1")
                document.getElementById('cpuAlertN').className = ("kpi-valor-alert-1")
                document.querySelector(".kpi-card.kpi-cpu").classList.add("border-orange")
            }

            if (mf.ram[4] >= metricaRam) {
                document.getElementById('ramAlert').className = ("kpi-valor-alert-2")
                document.getElementById('ramAlertN').className = ("kpi-valor-alert-2")
                document.querySelector(".kpi-card.kpi-ram").classList.add("border-red")
            } else if (mf.ram[4] >= (metricaRam * 0.80)) {
                document.getElementById('ramAlert').className = ("kpi-valor-alert-1")
                document.getElementById('ramAlertN').className = ("kpi-valor-alert-1")
                document.querySelector(".kpi-card.kpi-ram").classList.add("border-orange")
            }

            if (mf.disk[4] >= metricaDisk) {
                document.getElementById('diskAlert').className = ("kpi-valor-alert-2");
                document.getElementById('diskAlertN').className = ("kpi-valor-alert-2");
                document.querySelector(".kpi-card.kpi-disk").classList.add("border-red");
            } else if (mf.disk[4] >= (metricaDisk * 0.80)) {
                document.getElementById('diskAlert').className = ("kpi-valor-alert-1")
                document.getElementById('diskAlertN').className = ("kpi-valor-alert-1")
                document.querySelector(".kpi-card.kpi-disk").classList.add("border-orange")
            }

            document.getElementById(`mainF${id}`).className = "mainframe-evento clicked"
        }

        function initMainChart(id) {
            const ctx = document.getElementById("mainChart").getContext("2d")
            const mf = mainframesData[id];

            if (mainChart) mainChart.destroy()

            mainChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: mf.cpu.map((_, i) => `${i * 3}s`),
                    datasets: [
                        { label: "CPU", data: mf.cpu, borderColor: "#ef44d2", backgroundColor: "rgba(235, 37, 225, 0.15)", fill: true },
                        { label: "RAM", data: mf.ram, borderColor: "#46baaa", backgroundColor: "rgba(16, 185, 129, 0.25)", fill: true },
                        { label: "DISCO", data: mf.disk, borderColor: "#C1CF00DA", backgroundColor: "rgba(255,217,0,0.411)", fill: true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            })
        }

        function updateChartData() {
            const mf = mainframesData[currentMainframeId]
            updateMainKpis(currentMainframeId)

            if (mainChart) {
                mainChart.data.datasets[0].data = mf.cpu
                mainChart.data.datasets[1].data = mf.ram
                mainChart.data.datasets[2].data = mf.disk
                mainChart.update()
            }
        }

        function loadMainframeDetails(id) {
            currentMainframeId = id

            setMainframe(id+1)
            updateMainKpis(id)
            updateMainframeDetails(id)
            initMainChart(id)

            document.getElementById("mainfrane-title").innerText = ` ${id + 1}  ` + mainframesData[id].nome 
        }

        window.onload = () => {
            
            validarSessaoSynkro()
            buscarJsonS3().then(() => {
                renderMainframesList()
                loadMainframeDetails(currentMainframeId)
            })

            setInterval(updateChartData, 3000);
        }

        const modal = document.getElementById("modalOverlay")
        document.getElementById("openModalBtn").onclick = () => modal.style.display = "flex"
        document.getElementById("closeModalBtn").onclick = () => modal.style.display = "none"

    </script>

</body>

</html>