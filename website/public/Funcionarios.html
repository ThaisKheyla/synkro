<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcionários - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/funcionarios.css">
    <script src="./js/sessao.js"></script>
</head>

<body onload="carregarFuncionarios(), validarSessaoSynkro()">
    <div class="layout-principal">
        <!-- BARRA LATERAL -->
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/foto_perfil_padrao.webp" alt="Foto de perfil padrão">
                <div class="cargo-usuario">Gerente de Infra</div>
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li><a href="dashboardGerente.html" >Visão Geral</a></li>
                    <li><a href="historico.html">Logs e Histórico</a></li>
                    <li><a href="Funcionarios.html" class="ativo">Funcionários cadastrados</a></li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()">Sair do Sistema</button>
            </nav>
            
        </aside>

        <main class="conteudo-principal">
            <div class="dashboard-grid">
                <div class="visao-estrategica">
                    <div class="visao-header">
                        <h1>Funcionários Cadastrados</h1>
                    </div>

                    <div class="top-widgets">
                        <div class="widget-mainframes-small">
                            <h3>Lista de Funcionários</h3>

                            <table id="tabelaFuncionarios">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>E-mail</th>
                                        <th>Cargo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyFuncionarios">
                                    <tr>
                                        <td colspan="4">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="acoes-tabela">
                                <a href="CadastroFuncionario.html" class="btn-adicionar">
                                    <span>+</span>
                                    Adicionar Funcionário
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de edição -->
    <div id="modalEditar">
        <div>
            <h3>Editar Funcionário</h3>
            <form id="formEditar">
                <input type="hidden" id="editId">
                <label>Nome</label>
                <input id="editNome" required>
                <label>E-mail</label>
                <input id="editEmail" type="email" required>
                <div class="campo-erro" id="editEmailError"></div>
                <label>Data de nascimento</label>
                <input id="editNascimento" type="date">
                <label>CPF</label>
                <input id="editCpf" maxlength="14" placeholder="000.000.000-00" oninput="formatarCPF(this)">
                <div class="campo-erro" id="editCpfError"></div>
                <label>Cargo</label>
                <select id="editCargo"></select>
                <label>Status</label>
                <select id="editStatus">
                    <option value="1">Ativo</option>
                    <option value="0">Inativo</option>
                </select>

                <div class="acoes-modal">
                    <button type="button" id="btnCancelarEdit" class="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-salvar">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function carregarFuncionarios() {
            const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
            const cargoUsuarioRaw = sessionStorage.getItem("CARGO_USUARIO") || "";
            const cargoUsuario = String(cargoUsuarioRaw).toLowerCase();
            const isGerente = cargoUsuario === "gerente";

            const tbody = document.getElementById("tbodyFuncionarios");
            tbody.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`;

            try {
                const resposta = await fetch(`/funcionarios/empresa/${idEmpresa}`);
                if (!resposta.ok) throw new Error("Erro ao buscar funcionários");

                const funcionarios = await resposta.json();
                if (funcionarios.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4">Nenhum funcionário cadastrado.</td></tr>`;
                    return;
                }

                tbody.innerHTML = "";

                funcionarios.forEach(func => {
                    const id = func.id ?? func.idFuncionario ?? func.id;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${func.nome}</td>
                        <td>${func.email}</td>
                        <td>${func.cargo || ''}</td>
                        <td>
                            <button class="btn-editar" data-id="${id}">Editar</button>
                            <button class="btn-excluir" data-id="${id}">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                tbody.addEventListener('click', (ev) => {
                    const btn = ev.target.closest('button');
                    if (!btn) return;
                    const id = btn.dataset.id;
                    if (!id) return;

                    if (btn.classList.contains('btn-editar')) {
                        abrirEditar(id);
                        return;
                    }
                    if (btn.classList.contains('btn-excluir')) {
                        deletarFuncionario(id);
                        return;
                    }
                }, { once: false });

            } catch (erro) {
                console.error(erro);
                tbody.innerHTML = `<tr><td colspan="4" class="erro-texto">Erro ao carregar funcionários.</td></tr>`;
            }
        }

        async function abrirEditar(id) {
            try {
                const resp = await fetch(`/funcionarios/${id}`);
                if (!resp.ok) throw new Error("Não foi possível recuperar dados do funcionário.");
                const func = await resp.json();

                const cargosResp = await fetch('/funcionarios/cargos');
                const cargos = cargosResp.ok ? await cargosResp.json() : [];
                const cargoSelect = document.getElementById('editCargo');
                cargoSelect.innerHTML = cargos.map(c => `<option value="${c.idCargo}">${c.nome}</option>`).join('');

                document.getElementById('editId').value = id;
                document.getElementById('editNome').value = func.nome || '';
                document.getElementById('editEmail').value = func.email || '';

                document.getElementById('editNascimento').value = func.dtnascimento || func.dtnascimento || '';
                document.getElementById('editCpf').value = func.cpf || '';
                if (func.fkCargo) document.getElementById('editCargo').value = func.fkCargo;
                if (typeof func.statusAcesso !== 'undefined') document.getElementById('editStatus').value = func.statusAcesso ? "1" : "0";

                document.getElementById('editCpfError').textContent = '';
                document.getElementById('editEmailError').textContent = '';

                const modal = document.getElementById('modalEditar');
                modal.classList.add('active');
            } catch (err) {
                alert('Erro ao abrir edição: ' + err.message);
                console.error(err);
            }
        }

        document.getElementById('btnCancelarEdit').addEventListener('click', () => {
            const modal = document.getElementById('modalEditar');
            modal.classList.remove('active');
        });

        document.getElementById('editEmail').addEventListener('input', () => {
            document.getElementById('editEmailError').textContent = '';
            document.getElementById('editEmail').style.border = '';
        });

        document.getElementById('editCpf').addEventListener('input', () => {
            document.getElementById('editCpfError').textContent = '';
            document.getElementById('editCpf').style.border = '';
        });

        document.getElementById('formEditar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const payload = {
                nome: document.getElementById('editNome').value,
                email: document.getElementById('editEmail').value,
                dtnascimento: document.getElementById('editNascimento').value || null,
                cpf: document.getElementById('editCpf').value,
                fkCargo: parseInt(document.getElementById('editCargo').value, 10),
                statusAcesso: parseInt(document.getElementById('editStatus').value, 10)
            };

            try {
                const resp = await fetch(`/funcionarios/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    alert('✅ Funcionário atualizado com sucesso!');
                    document.getElementById('modalEditar').classList.remove('active');
                    carregarFuncionarios();
                    return;
                }

                const erro = await resp.json().catch(() => ({}));
                const msg = erro.mensagem || resp.statusText || 'Erro desconhecido';

                if (resp.status === 409) {
                    if (/cpf/i.test(msg)) {
                        document.getElementById('editCpfError').textContent = msg;
                        document.getElementById('editCpf').style.border = '2px solid var(--perigo)';
                        document.getElementById('editCpf').focus();
                    } else if (/email/i.test(msg)) {
                        document.getElementById('editEmailError').textContent = msg;
                        document.getElementById('editEmail').style.border = '2px solid var(--perigo)';
                        document.getElementById('editEmail').focus();
                    } else {
                        alert('Erro: ' + msg);
                    }
                } else {
                    alert('Erro ao atualizar: ' + msg);
                }
            } catch (err) {
                alert('Servidor indisponível: ' + err.message);
                console.error(err);
            }
        });

        function deletarFuncionario(id) {
            if (!confirm("Tem certeza que deseja excluir este funcionário?")) return;

            fetch(`/funcionarios/${id}`, { method: "DELETE" })
                .then(res => {
                    if (!res.ok) throw new Error();
                    alert("✅ Funcionário removido com sucesso!");
                    carregarFuncionarios();
                })
                .catch(() => alert("❌ Erro ao remover funcionário."));
        }

        function formatarCPF(input) {
            let valor = input.value.replace(/\D/g, "");
            valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
            valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
            valor = valor.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            input.value = valor;
        }
    </script>
</body>

</html>
</body>

</html>