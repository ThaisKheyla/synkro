<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard Gerencial - Synkro</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- CSS (coloque este arquivo como css/dashMainframesGerente.css) -->
    <link rel="stylesheet" href="./css/dashMainframesGerente.css">
</head>


<body>
    <div class="layout-principal">
        <!-- ==== BARRA LATERAL (COPIADA SEM ALTERAÇÕES) ==== -->
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
                <div class="nome-usuario" id="nome_login">Marcos Silva</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Gerente de Infra
                </div>
                <div class="email-usuario" id="email_login">marcos.silva@empresa1.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li><a href="dashboardGerente.html"><i class="ri-dashboard-3-line"></i>Visão Geral</a></li>
                    <li><a href="visaoMainframesGerente.html" class="ativo"><i
                                class="ri-dashboard-3-line"></i>Mainframes</a></li>
                    <li><a href="historico.html"><i class="ri-file-add-line icon-cadastro"></i>Logs e Histórico</a></li>
                    <li><a href="Funcionarios.html"><i class="ri-database-2-line"></i>Funcionários cadastrados</a></li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()"><i class="ri-logout-box-r-line"></i>Encerrar
                    Sessão</button>
            </nav>
        </aside>

        <!-- ==== CONTEÚDO PRINCIPAL - DASHBOARD (REESCRITO) ==== -->
        <main class="conteudo-dashboard dashboard-mainframe">
            <header class="dashboard-header">
                <h2 class="titulo-principal">Histórico Total</h2>
                <div class="header-sep"></div>
            </header>

            <!-- TOP ROW: KPIs -->
            <section class="top-row">
                <div class="kpi-grid">
                    <div class="kpi-card kpi-total card">
                        <div class="kpi-title">Total de Alertas</div>
                        <div id="kpi-total" class="kpi-value">0</div>
                        <div id="kpi-media" class="kpi-sub">MÉDIA (0.0/DIA)</div>
                    </div>

                    <div class="kpi-card kpi-critical card">
                        <div class="kpi-title">Componente Crítico</div>
                        <div class="kpi-critical-main">
                            <div id="kpi-componente" class="kpi-value-large">CPU</div>
                            <div class="donut-wrap">
                                <canvas id="donutComp" width="140" height="140"></canvas>
                            </div>
                        </div>
                        <div id="kpi-comp-sub" class="kpi-sub">0 Alertas (Muito Urgente)</div>
                    </div>

                    <div class="kpi-card kpi-peak card kpi-blue">
                        <div class="kpi-title white">Pico de alertas</div>
                        <div class="kpi-peak-content">
                            <div class="peak-line"><span>Dia: </span><strong id="kpi-pico">-</strong></div>
                            <div class="peak-line"><span>Horário: </span><strong id="kpi-horario">-</strong></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ANALYSIS SECTION -->
            <section class="analysis">
                <div class="analysis-header-line">
                    <h3 class="analysis-title">Análise</h3>

                    <button id="periodBtn" class="period-btn analysis-btn">
                        Últimos 7 dias <i class="ri-arrow-down-s-line"></i>
                    </button>
                </div>
                <div class="analysis-sep"></div>

                <div class="analysis-grid">
                    <!-- Left: Large history line -->
                    <div class="history-card card">
                        <div class="history-header">
                            <div class="chart-title">Histórico de todos os Alertas</div>
                            <div id="trendBadge" class="trend-badge">▲ +2%</div>
                        </div>
                        <canvas id="historyLine" height="420"></canvas>


                    </div>

                    <!-- Right: two stacked charts -->
                    <div class="right-charts">
                        <div class="card chart-small">
                            <div class="chart-title">Alertas por Componente</div>
                            <canvas id="componentsBar" style="height:160px;"></canvas>
                        </div>
                        <div class="card chart-small lower">
                            <div class="chart-title">Alertas por Horas do Dia</div>
                            <canvas id="hourlyBar" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        /* =========================
           CONFIGURAÇÃO / VARIÁVEIS
           ========================= */
        const ARQUIVO_ALERTA_S3 = "alertas.json"; // rota relativa - ajuste se necessário
        const ID_SESSAO_MAINFRAME = 'ID_MAINFRAME_SELECIONADO';

        const palette = {
            cpu: 'rgba(64,201,255,0.95)',   // tom claro/azul
            ram: 'rgba(69,170,242,0.95)',   // azul diferenciado
            disco: 'rgba(46,172,163,0.95)', // teal/verde
            padrao: 'rgba(148,163,184,0.9)',
            bgLight: 'rgba(255,255,255,0.03)'
        };

        let componentsChart = null;
        let hourlyChart = null;
        let historyChart = null;
        let donutChart = null;
        let dadosProcessadosGlobal = null;

        /* =========================
           ON LOAD
           ========================= */
        window.onload = async function () {
            
            const macSelecionado = sessionStorage.getItem(ID_SESSAO_MAINFRAME);
            if (!macSelecionado) {
                // se não tiver mac, tenta pegar um exemplo (útil para dev local)
                console.warn('Nenhum mainframe selecionado na sessão. Usando todos os alertas (modo dev).');
            }
            await carregarDadosDetalhados(macSelecionado);
            initTabs();
        };
        

        /* =========================
           BUSCA E PROCESSAMENTO
           ========================= */
        async function carregarDadosDetalhados(macAlvo) {
            try {
                const res = await fetch(`/dados/${ARQUIVO_ALERTA_S3}`);
                if (!res.ok) throw new Error('Erro ao buscar dados S3: ' + res.status);
                const todosAlertas = await res.json();

                // se macAlvo definido, filtra, caso contrário usa todos
                const alertasMainframe = macAlvo ? todosAlertas.filter(a => String(a.macAdress) === String(macAlvo)) : todosAlertas;

                if (!alertasMainframe || alertasMainframe.length === 0) {
                    document.querySelector('.titulo-principal').innerText = 'Visão Geral dos Alertas (Sem dados)';
                    return;
                }

                // Título com identificação
                const nomeMf = alertasMainframe[0].identificacaoMainframe || (macAlvo || 'Mainframe');
                document.querySelector('.titulo-principal').innerText = `Histórico Total`;

                // KPIs e gráficos
                processarKPIs(alertasMainframe);
                processarGraficoHoras(alertasMainframe);
                processarGraficoComponentes(alertasMainframe);
                dadosProcessadosGlobal = processarDadosHistorico(alertasMainframe);
                createHistoryChart(dadosProcessadosGlobal.labels, dadosProcessadosGlobal.todos);
                createDonut(alertasMainframe);
            } catch (err) {
                console.error('Erro ao carregar dados:', err);
            }
        }

        /* =========================
           UTILITÁRIOS
           ========================= */
        function parseDate(dataString) {
            // "2025-11-21 12:45:00" -> Date
            if (!dataString) return new Date();
            return new Date(dataString.replace(' ', 'T'));
        }

        function normalizarComponente(nome) {
            if (!nome) return "Outros";
            const n = nome.toLowerCase();
            if (n.includes('processador') || n.includes('cpu')) return 'CPU';
            if (n.includes('memoria') || n.includes('ram')) return 'RAM';
            if (n.includes('disco') || n.includes('disk')) return 'Disco';
            return 'Outros';
        }

        function normalizarTipo(tipoString) {
            if (!tipoString) return 'todos';
            const t = tipoString.toLowerCase();
            if (t.includes('muito')) return 'muitoUrgente';
            if (t.includes('emerg')) return 'emergencia';
            if (t.includes('urgent')) return 'urgente';
            return 'todos';
        }

        function getKeyComMaiorValor(obj) {
            if (!obj || Object.keys(obj).length === 0) return "-";
            let maxKey = null;
            let maxVal = -Infinity;
            for (const k of Object.keys(obj)) {
                const v = obj[k] || 0;
                if (v > maxVal) { maxVal = v; maxKey = k; }
            }
            return maxKey || "-";
        }

        /* =========================
           KPIs
           ========================= */
        function processarKPIs(alertas) {
            const total = alertas.length;
            document.getElementById('kpi-total').innerText = total;

            // Média por 7 dias
            const media = (total / 7);
            document.getElementById('kpi-media').innerText = `MÉDIA (${media.toFixed(1)}/DIA)`;

            // contagens
            const contagemDias = {};
            const contagemHoras = {};
            const contagemComp = {};

            alertas.forEach(a => {
                const d = parseDate(a.dtHora);
                const dia = d.toLocaleDateString('pt-BR', { weekday: 'long' });
                contagemDias[dia] = (contagemDias[dia] || 0) + 1;

                const hora = String(d.getHours()).padStart(2, '0') + ':00';
                contagemHoras[hora] = (contagemHoras[hora] || 0) + 1;

                const comp = normalizarComponente(a.componente);
                contagemComp[comp] = (contagemComp[comp] || 0) + 1;
            });

            const topDia = getKeyComMaiorValor(contagemDias);
            const topHora = getKeyComMaiorValor(contagemHoras);
            const topComp = getKeyComMaiorValor(contagemComp);

            const qtdTopDia = contagemDias[topDia] || 0;
            const qtdTopHora = contagemHoras[topHora] || 0;
            const qtdTopComp = contagemComp[topComp] || 0;

            document.getElementById('kpi-pico').innerText = topDia !== '-' ? `${capitalize(topDia)} (${qtdTopDia} Alertas)` : '-';
            document.getElementById('kpi-horario').innerText = topHora !== '-' ? `${topHora} (${qtdTopHora} Alertas)` : '-';
            document.getElementById('kpi-componente').innerText = topComp || '-';
            document.getElementById('kpi-comp-sub').innerText = `${qtdTopComp} Alertas (Muito Urgente)`;
        }

        function capitalize(s) {
            if (!s) return s;
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        /* =========================
           GRAFICO DE COMPONENTES (BAR HORIZONTAL)
           ========================= */
        function processarGraficoComponentes(alertas) {
            const contagem = {};
            alertas.forEach(a => {
                const c = normalizarComponente(a.componente);
                contagem[c] = (contagem[c] || 0) + 1;
            });

            // Ordena por maior
            const sorted = Object.entries(contagem).sort(([, a], [, b]) => b - a);
            const labels = sorted.map(([k]) => k);
            const data = sorted.map(([, v]) => v);
            const bgColors = labels.map(l => {
                if (l === 'CPU') return palette.cpu;
                if (l === 'RAM') return palette.ram;
                if (l === 'Disco') return palette.disco;
                return palette.padrao;
            });

            const ctx = document.getElementById('componentsBar').getContext('2d');
            if (componentsChart) componentsChart.destroy();
            componentsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: bgColors, borderRadius: 8 }] },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    responsive: true,
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#cbd5e1' } },
                        y: { ticks: { color: '#cbd5e1' }, grid: { display: false } }
                    }
                }
            });
        }

        /* =========================
           GRAFICO HORAS (BAR VERTICAL)
           ========================= */
        function processarGraficoHoras(alertas) {
            const horasData = Array(24).fill(0);
            const labels = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0') + ':00');

            alertas.forEach(a => {
                const d = parseDate(a.dtHora);
                const h = d.getHours();
                if (!isNaN(h)) horasData[h]++;
            });

            const ctx = document.getElementById('hourlyBar').getContext('2d');
            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: horasData, backgroundColor: 'rgba(69,170,242,0.9)', borderRadius: 4 }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#cbd5e1', maxRotation: 0 }, grid: { color: 'rgba(255,255,255,0.02)' } },
                        y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.02)' } }
                    }
                }
            });
        }

        /* =========================
           HISTÓRICO (LINHA) - 7 DIAS
           ========================= */
        function processarDadosHistorico(alertas) {
            // Labels últimos 7 dias (dd/mm)
            const hoje = new Date();
            const labels = [];
            const mapaIndex = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(hoje.getDate() - i);
                const label = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                labels.push(label);
                mapaIndex[label] = labels.length - 1;
            }

            const criar = () => ({ CPU: Array(7).fill(0), RAM: Array(7).fill(0), Disco: Array(7).fill(0) });
            const dados = { labels, todos: criar(), urgente: criar(), muitoUrgente: criar(), emergencia: criar() };

            alertas.forEach(a => {
                const d = parseDate(a.dtHora);
                const label = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                if (!(label in mapaIndex)) return;
                const idx = mapaIndex[label];
                const comp = normalizarComponente(a.componente);
                const tipo = normalizarTipo(a.gravidade);

                if (dados.todos[comp]) dados.todos[comp][idx]++;

                if (tipo !== 'todos' && dados[tipo] && dados[tipo][comp] !== undefined) {
                    dados[tipo][comp][idx]++;
                }
            });

            return dados;
        }

        function createHistoryChart(labels, datasetGroup) {
            const ctx = document.getElementById('historyLine').getContext('2d');
            if (historyChart) historyChart.destroy();

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'CPU', data: datasetGroup.CPU, borderColor: palette.cpu, backgroundColor: 'rgba(64,201,255,0.08)', tension: 0.35, pointRadius: 4, fill: true },
                        { label: 'RAM', data: datasetGroup.RAM, borderColor: palette.ram, backgroundColor: 'rgba(69,170,242,0.06)', tension: 0.35, pointRadius: 4, fill: true },
                        { label: 'Disco', data: datasetGroup.Disco, borderColor: palette.disco, backgroundColor: 'rgba(46,172,163,0.06)', tension: 0.35, pointRadius: 4, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: {
                        x: { ticks: { color: '#9aa4b2' }, grid: { color: 'rgba(255,255,255,0.02)' } },
                        y: { ticks: { color: '#9aa4b2' }, grid: { color: 'rgba(255,255,255,0.02)' } }
                    }
                }
            });
        }

        /* =========================
           DONUT (COMPOSIÇÃO POR COMPONENTE)
           ========================= */
        function createDonut(alertas) {
            const contagem = { CPU: 0, RAM: 0, Disco: 0, Outros: 0 };
            alertas.forEach(a => {
                const c = normalizarComponente(a.componente);
                contagem[c] = (contagem[c] || 0) + 1;
            });
            const labels = Object.keys(contagem);
            const data = labels.map(l => contagem[l]);
            const colors = labels.map(l => l === 'CPU' ? palette.cpu : (l === 'RAM' ? palette.ram : (l === 'Disco' ? palette.disco : palette.padrao)));

            const ctx = document.getElementById('donutComp').getContext('2d');
            if (donutChart) donutChart.destroy();
            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors, cutout: '70%' }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        /* =========================
           INICIALIZAÇÃO DE TABS / BOTÕES
           ========================= */
        function initTabs() {
            // aqui podemos adicionar comportamento do botão de período se quiser
            document.getElementById('periodBtn').addEventListener('click', () => {
                alert('Filtro de período (apenas demo) — por enquanto sempre últimos 7 dias');
            });

            // inicializa filtros visuais (se houver)
            // se quiser trocar séries (Todos / Urgente / Emergência), podemos adicionar botões
        }

        /* =========================
           UTIL - CAPTURA DOS DADOS PROCESSADOS E RENDERIZAÇÃO
           ========================= */

        document.addEventListener('click', (e) => {
            // exemplo: futuramente fazer troca de séries do histórico
        });

        /* =========================
           FINAL
           ========================= */
    </script>
</body>

</html>