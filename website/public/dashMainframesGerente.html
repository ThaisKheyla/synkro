<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Gerencial - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/dashMainframesGerente.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="layout-principal">
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Gerente de Infra
                </div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li><a href="dashboardGerente.html"><i class="ri-dashboard-3-line"></i>Visão Geral</a></li>
                    <li><a href="visaoMainframesGerente.html" class="ativo"><i
                                class="ri-dashboard-3-line"></i>Mainframes</a></li>
                    <li><a href="historico.html"><i class="ri-file-add-line icon-cadastro"></i>Logs e Histórico</a></li>
                    <li><a href="Funcionarios.html"><i class="ri-database-2-line"></i>Funcionários cadastrados</a></li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()"><i class="ri-logout-box-r-line"></i>Encerrar
                    Sessão</button>
            </nav>
        </aside>
        <main class="conteudo-dashboard dashboard-mainframe">
            <h3 class="titulo-dashboard">
                Visão dos Alertas da Última Semana do Mainframe: Z15
            </h3>
            <div class="container-grid">

                <!-- TOP KPIS (ocupa col 1/3) -->
                <div class="top-kpis">
                    <div class="kpi-card">
                        <div class="kpi-title">Total de Alertas</div>
                        <div id="kpi-total" class="kpi-value" style="color:var(--emergencia);">100</div>
                        <div class="kpi-sub"><span
                                style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--emergencia);margin-right:8px;"></span>
                            Emergência | Média de <strong id="kpi-media">14.2</strong> alertas por dia</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-title">Pico de Alertas</div>
                        <div id="kpi-pico" class="kpi-value" style="color:var(--emergencia);">Segunda-feira</div>
                        <div class="kpi-sub"><span
                                style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--emergencia);margin-right:8px;"></span>
                            Emergência | 10 alertas</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-title">Horário da semana com mais alertas</div>
                        <div id="kpi-horario" class="kpi-value" style="color: var(--urgente);">12:00</div>
                        <div class="kpi-sub"><span
                                style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--urgente);margin-right:8px;"></span>
                            Urgente | 6 alertas</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-title">Componente com mais alerta</div>
                        <div id="kpi-componente" class="kpi-value" style="color: var(--muito-urgente);">CPU</div>
                        <div class="kpi-sub"><span
                                style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--muito-urgente);margin-right:8px;"></span>
                            Muito urgente | 20 alertas</div>
                    </div>
                </div>

                <!-- MIDDLE: Charts (componentes e hora do dia) -->
                <div class="card chart-left card">
                    <div class="chart-title">Componentes com mais alertas</div>
                    <canvas id="componentsBar"></canvas>
                </div>

                <div class="card chart-right card">
                    <div class="chart-title">Horários com mais alertas na semana</div>
                    <canvas id="hourlyBar"></canvas>
                </div>

                <!-- LOWER: Histórico com abas -->
                <div class="history-card card">
                    <div class="history-tabs">
                        <button class="tab-btn active" data-filter="todos">Todos</button>
                        <button class="tab-btn" data-filter="urgente">Urgente</button>
                        <button class="tab-btn" data-filter="muitoUrgente">Muito Urgente</button>
                        <button class="tab-btn" data-filter="emergencia">Emergência</button>
                    </div>

                    <div class="history-graph">
                        <div class="chart-title" style="margin-bottom:6px;">Histórico de todos os alertas na última
                            semana</div>
                        <div class="trend-badge" id="trendBadge" style="color:var(--emergencia);">▲ +2% na comparação
                            com semana anterior</div>
                        <canvas id="historyLine" style="height: 230px;"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

   <script>
    // --- CONFIGURAÇÃO ---
    const ARQUIVO_ALERTA_S3 = "alertas.json"; // Nome do arquivo no bucket
    const ID_SESSAO_MAINFRAME = 'ID_MAINFRAME_SELECIONADO';
    
    // Cores para os gráficos (padrão mantido: CPU, RAM, Disco)
    const palette = {
        cpu: 'rgba(99,102,241,0.95)',   // Roxo 
        ram: 'rgba(56,189,248,0.95)',   // Azul 
        disco: 'rgba(34,197,94,0.95)',  // Verde 
        padrao: 'rgba(156, 163, 175, 0.9)' 
    };

    // Variáveis Globais de Gráficos e Dados
    let componentsChart = null;
    let hourlyChart = null;
    let historyChart = null;
    let dadosProcessadosGlobal = {};

    window.onload = async function () {
        // Recupera o MAC Address salvo na tela anterior
        const macSelecionado = sessionStorage.getItem(ID_SESSAO_MAINFRAME);
        
        if (!macSelecionado) {
            alert("Nenhum mainframe selecionado. Redirecionando...");
            window.location.href = "visaoMainframesGerente.html";
            return;
        }

        await carregarDadosDetalhados(macSelecionado);
        initTabs(); 
    };

    async function carregarDadosDetalhados(macAlvo) {
        try {
            const resposta = await fetch(`/dados/${ARQUIVO_ALERTA_S3}`);
            if (!resposta.ok) throw new Error("Erro ao buscar dados S3");
            
            const todosAlertas = await resposta.json();

            // 1. FILTRAGEM: Apenas itens com o macAdress selecionado
            const alertasMainframe = todosAlertas.filter(a => String(a.macAdress) === String(macAlvo));

            if (alertasMainframe.length === 0) {
                const nomeMf = sessionStorage.getItem('NOME_MAINFRAME') || macAlvo;
                document.querySelector('.titulo-dashboard').innerText = `Mainframe: ${nomeMf} (Sem dados recentes)`;
                return; 
            }

            // Atualiza Título
            const nomeMf = alertasMainframe[0].identificacaoMainframe || macAlvo;
            document.querySelector('.titulo-dashboard').innerText = `Visão dos Alertas da Última Semana: ${nomeMf}`;
            // Salva nome para usar se o mac for o ID
            sessionStorage.setItem('NOME_MAINFRAME', nomeMf);

            // 2. PROCESSAMENTO
            processarKPIs(alertasMainframe);
            processarGraficoHoras(alertasMainframe);
            processarGraficoComponentes(alertasMainframe);
            
            dadosProcessadosGlobal = processarDadosHistorico(alertasMainframe);
            
            // Renderiza gráfico inicial (Todos)
            createHistoryChart(dadosProcessadosGlobal.labels, dadosProcessadosGlobal.todos);

        } catch (erro) {
            console.error("❌ Erro na dashboard:", erro);
        }
    }

    // --- FUNÇÕES AUXILIARES DE TRATAMENTO ---
    
    // Converte datas "2025-11-21 12:45:00" para Objeto Date JS
    function parseDate(dataString) {
        // Substitui espaço por T para garantir compatibilidade ISO
        return new Date(dataString.replace(' ', 'T'));
    }

    // Padroniza nomes para agrupar nos gráficos (Ex: Processador -> CPU)
    function normalizarComponente(nome) {
        if (!nome) return "Outros";
        const n = nome.toLowerCase();
        if (n.includes('processador') || n.includes('cpu')) return 'CPU';
        if (n.includes('memoria') || n.includes('ram')) return 'RAM';
        if (n.includes('disco') || n.includes('disk')) return 'Disco';
        return 'Outros'; 
    }

    // --- KPIS ---
    function processarKPIs(alertas) {
        document.getElementById('kpi-total').innerText = alertas.length;
        document.getElementById('kpi-media').innerText = (alertas.length / 7).toFixed(1);

        const contagemDias = {};
        const contagemHoras = {};
        const contagemComp = {};

        alertas.forEach(a => {
            const data = parseDate(a.dtHora);
            
            // Dia
            const diaSemana = data.toLocaleDateString('pt-BR', { weekday: 'long' });
            contagemDias[diaSemana] = (contagemDias[diaSemana] || 0) + 1;

            // Hora
            const hora = data.getHours() + ":00";
            contagemHoras[hora] = (contagemHoras[hora] || 0) + 1;

            // Componente (Normalizado)
            const comp = normalizarComponente(a.componente);
            contagemComp[comp] = (contagemComp[comp] || 0) + 1;
        });

        // Atualiza os KPIs
        const totalTopDia = contagemDias[getKeyComMaiorValor(contagemDias)] || 0;
        const totalTopHora = contagemHoras[getKeyComMaiorValor(contagemHoras)] || 0;
        const totalTopComp = contagemComp[getKeyComMaiorValor(contagemComp)] || 0;
        
        document.getElementById('kpi-pico').innerText = getKeyComMaiorValor(contagemDias) || "-";
        document.querySelector('#kpi-pico').nextElementSibling.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--emergencia);margin-right:8px;"></span> Emergência | ${totalTopDia} alertas`;

        document.getElementById('kpi-horario').innerText = getKeyComMaiorValor(contagemHoras) || "-";
        document.querySelector('#kpi-horario').nextElementSibling.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--urgente);margin-right:8px;"></span> Urgente | ${totalTopHora} alertas`;

        document.getElementById('kpi-componente').innerText = getKeyComMaiorValor(contagemComp) || "-";
        document.querySelector('#kpi-componente').nextElementSibling.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--muito-urgente);margin-right:8px;"></span> Muito urgente | ${totalTopComp} alertas`;
    }

    function getKeyComMaiorValor(obj) {
        return Object.keys(obj).reduce((a, b) => (obj[a] > obj[b] ? a : b), "");
    }

    // --- GRÁFICO 1: COMPONENTES ---
    function processarGraficoComponentes(alertas) {
        const contagem = {};
        alertas.forEach(a => {
            const comp = normalizarComponente(a.componente);
            contagem[comp] = (contagem[comp] || 0) + 1;
        });

        // Filtra "Outros" se for 0 e ordena
        const sorted = Object.entries(contagem).sort(([, a], [, b]) => b - a);
        const labels = sorted.map(([k]) => k);
        const data = sorted.map(([, v]) => v);
        
        const bgColors = labels.map(l => {
            if(l === 'CPU') return palette.cpu;
            if(l === 'RAM') return palette.ram;
            if(l === 'Disco') return palette.disco;
            return palette.padrao;
        });

        const ctx = document.getElementById('componentsBar').getContext('2d');
        if (componentsChart) componentsChart.destroy();

        componentsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Qtd Alertas',
                    data: data,
                    backgroundColor: bgColors,
                    borderRadius: 8,
                    barThickness: 20
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#ffffff' } },
                    y: { ticks: { color: '#ffffff' }, grid: { display: false } }
                }
            }
        });
    }

    // --- GRÁFICO 2: HORAS ---
    function processarGraficoHoras(alertas) {
        const horasData = Array(24).fill(0);
        const labels = Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0') + ":00");

        alertas.forEach(a => {
            const h = parseDate(a.dtHora).getHours();
            if (!isNaN(h)) horasData[h]++;
        });

        const ctx = document.getElementById('hourlyBar').getContext('2d');
        if (hourlyChart) hourlyChart.destroy();

        hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Alertas',
                    data: horasData,
                    backgroundColor: 'rgba(56,189,248,0.85)',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#ffffff', font: {size: 10} } },
                    y: { display: false }
                }
            }
        });
    }
    
    // --- GRÁFICO 3: HISTÓRICO (Linha) ---
    function normalizarTipo(tipoString) {
        if (!tipoString) return 'todos';
        const t = tipoString.toLowerCase();
        if (t.includes('muito')) return 'muitoUrgente';
        if (t.includes('emerg')) return 'emergencia';
        if (t.includes('urgent')) return 'urgente';
        return 'todos';
    }

    function processarDadosHistorico(alertas) {
        const hoje = new Date(); 
        const diasLabels = [];
        const mapaDataIndex = {}; 

        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(hoje.getDate() - i);
            const label = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            diasLabels.push(label);
            mapaDataIndex[label] = 6 - i; 
        }

        const criarSeries = () => ({ CPU: Array(7).fill(0), RAM: Array(7).fill(0), Disco: Array(7).fill(0) });
        
        const dados = {
            labels: diasLabels,
            todos: criarSeries(),
            urgente: criarSeries(),
            muitoUrgente: criarSeries(),
            emergencia: criarSeries()
        };

        alertas.forEach(a => {
            const dataObj = parseDate(a.dtHora);
            const label = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            
            if (mapaDataIndex.hasOwnProperty(label)) {
                const idx = mapaDataIndex[label];
                const comp = normalizarComponente(a.componente); 
                const tipo = normalizarTipo(a.gravidade);
                
                if (dados.todos[comp]) {
                    dados.todos[comp][idx]++;
                    if (tipo !== 'todos' && dados[tipo]) {
                        dados[tipo][comp][idx]++;
                    }
                }
            }
        });

        return dados;
    }

    function createHistoryChart(labels, datasetGroup) {
        const ctx = document.getElementById('historyLine').getContext('2d');
        if (historyChart) historyChart.destroy();

        historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'CPU',
                        data: datasetGroup.CPU,
                        borderColor: palette.cpu,
                        backgroundColor: palette.cpu.replace('0.95', '0.1'),
                        tension: 0.4, pointRadius: 3, fill: true
                    },
                    {
                        label: 'RAM',
                        data: datasetGroup.RAM,
                        borderColor: palette.ram,
                        backgroundColor: palette.ram.replace('0.95', '0.1'),
                        tension: 0.4, pointRadius: 3, fill: true
                    },
                    {
                        label: 'Disco',
                        data: datasetGroup.Disco,
                        borderColor: palette.disco,
                        backgroundColor: palette.disco.replace('0.95', '0.1'),
                        tension: 0.4, pointRadius: 3, fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#ccc', font: {size: 11} } }
                },
                scales: {
                    x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.02)' } },
                    y: { ticks: { color: '#aaa', precision:0, beginAtZero: true }, grid: { color: 'rgba(255,255,255,0.02)' } }
                }
            }
        });
    }

    // --- Tabs behavior (filter history) ---
    function initTabs() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.getAttribute('data-filter');
                const dadosParaPlotar = dadosProcessadosGlobal[filter] || dadosProcessadosGlobal.todos;
                
                createHistoryChart(dadosProcessadosGlobal.labels, dadosParaPlotar);
                // Lógica de atualização do trendBadge (mantida do seu original)
                const badge = document.getElementById('trendBadge');
                    if (filter === 'todos') {
                        badge.innerText = '▲ +2% na comparação com semana anterior';
                        badge.style.background = 'rgba(220,38,38,0.08)';
                        badge.style.color = 'var(--emergencia)';
                    } else if (filter === 'urgente') {
                        badge.innerText = '▲ +8% (urgente)';
                        badge.style.background = 'rgba(220,38,38,0.08)';
                        badge.style.color = 'var(--emergencia)';
                    } else if (filter === 'muitoUrgente') {
                        badge.innerText = '▼ -6% (muito urgente)';
                        badge.style.background = 'rgba(16,185,129,0.06)';
                        badge.style.color = 'var(--sucesso)';
                    } else if (filter === 'emergencia') {
                        badge.innerText = '▲ +12% (emergência)';
                        badge.style.background = 'rgba(220,38,38,0.08)';
                        badge.style.color = 'var(--emergencia)';
                    }
            });
        });
    }
</script>
</body>

</html>