<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Gerencial - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/dashGerente.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/sessao.js"></script>
    <script src="./js/dashboard.js"></script>
</head>

<body onload="validarSessaoSynkro()">
    <div class="layout-principal">

        <!--Barra lateral-->
        <aside class="barra-lateral">
            <div class="logo">
                Synkro
            </div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão" />
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Gerente de Infra
                </div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li>
                        <a href="dashboardGerente.html" class="ativo">
                            <i class="ri-dashboard-3-line"></i>
                            Visão Geral
                        </a>
                    </li>
                    <li>
                        <a href="visaoMainframesGerente.html">
                            <i class="ri-server-line"></i>
                            Mainframes
                        </a>
                    </li>
                    <li>
                        <a href="historico.html">
                            <i class="ri-file-add-line icon-cadastro"></i>
                            Logs e Histórico
                        </a>
                    </li>
                    <li>
                        <a href="Funcionarios.html">
                            <i class="ri-database-2-line"></i>
                            Funcionários cadastrados
                        </a>
                    </li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()">
                    <i class="ri-logout-box-r-line"></i>
                    Encerrar Sessão
                </button>
            </nav>
        </aside>


        <div class="conteudo-principal dashboard">

            <div class="btn-periodo-container">
                <button class="btn-periodo" id="btnPeriodo">
                    Última Semana <i class="ri-arrow-down-s-line"></i>
                </button>
                <ul class="dropdown-periodo" id="dropdownPeriodo" role="menu" aria-labelledby="btnPeriodo">


                    <li data-periodo="semana">Última Semana</li>
                    <li data-periodo="mes">Último Mês</li>
                    <li data-periodo="semestre">Último Semestre</li>
                    <li data-periodo="ano">Último Ano</li>
                </ul>
            </div>


            <section class="painel-kpis-principal">
                <div class="kpi-principal" id="kpiTotalAlertasCard">
                    <span class="kpi-label">Total de Alertas</span>
                    <span class="kpi-value azul" id="kpiTotalAlertas">46</span>
                    <div class="kpi-breakdown" id="kpiBreakdown">

                    </div>

                </div>
                <div class="kpi-principal" id="kpiMainframeCriticoCard">
                    <span class="kpi-label">Mainframe Crítico</span>
                    <span class="kpi-value alerta" id="kpiMainframesCritico">MF-2</span>
                    <div class="kpi-mainframe-details" id="kpiComponenteCritico">CPU com 25 alertas</div>

                </div>
                <div class="kpi-principal" id="kpiDisponibilidadeCard">
                    <span class="kpi-label">Taxa de Disponibilidade</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="kpi-value verde" id="kpiDisponibilidade">98.5%</span>
                        <span id="kpiSlaBadge" class="badge-sla" style="display:none"></span>
                    </div>
                    <div class="kpi-disponibilidade-contrato" id="kpiDisponibilidadeDescricao">Uptime da infraestrutura
                    </div>
                </div>
            </section>


            <section class="painel-graficos-novo">

                <div class="coluna-esquerda">
                    <div class="grafico grafico-mainframes">
                        <h3>Mainframes com Mais Alertas</h3>
                        <canvas id="graficoMainframes"></canvas>
                    </div>
                </div>


                <div class="coluna-direita">
                    <div class="kpi-pico">
                        <span class="kpi-label">Tempo de Recuperação (RTO)</span>
                        <span class="kpi-value azul" id="kpiPico">RTO alvo: 2h — Atual: 3h 20m</span>
                        <div style="font-size: 0.8rem;" id="kpiRtoDescricao">RTO = tempo máximo aceitável para
                            restauração</div>

                    </div>
                    <div class="grafico grafico-componentes">
                        <div class="filtros-tempo" role="toolbar" aria-label="Filtros tempo de solução">
                            <button class="filtro-btn ativo" data-filtro="all">Todos</button>
                            <button class="filtro-btn" data-filtro="alta">Alta</button>
                            <button class="filtro-btn" data-filtro="media">Média</button>
                            <button class="filtro-btn" data-filtro="baixa">Baixa</button>
                        </div>
                        <h3>Tempo de solução de incidentes</h3>
                        <canvas id="graficoComponentes"></canvas>
                        <div class="legenda-tempo" id="legendaTempo"
                            style="margin-top:8px;font-size:0.9rem;color:#cbd5e1;">
                            Comparação: objetivo (SLA) x tempo médio atual por criticidade
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const SLA_CONTRATADO = 99.9;
        //padrao itil
        const SLA_TARGETS = {
            alta: 60,      
            media: 180,    
            baixa: 480     
        };

        let periodoAtual = 'semana';
        let tempoFiltro = 'all';

        function getPeriodoData(periodo) {
            const rawPeriod = window.dashboardData && window.dashboardData[periodo];
            if (!rawPeriod) return null;
            const hosts = Object.keys(rawPeriod);
            if (hosts.length === 0) return null;
            const hostName = hosts[0];
            const hostData = rawPeriod[hostName] || {};
            hostData._hostName = hostName;
            return hostData;
        }

        window.addEventListener('dashboardDataLoaded', (e) => {
            console.log("Dashboard atualizado com dados do S3!");
            atualizarDashboard(periodoAtual);
        });

        function formatPercent(n, decimals = 1) {
            return Number(n).toFixed(decimals) + '%';
        }

        function minutesToHuman(minutes) {
            if (minutes === null || minutes === undefined) return '-';
            const m = Math.round(minutes);
            if (m < 60) return `${m}m`;
            const hh = Math.floor(m / 60);
            const mm = m % 60;
            return `${hh}h${mm > 0 ? ' ' + mm + 'm' : ''}`;
        }

        function calcularImpactoSLA(alertasMf, kpisTotal) {
            if (!kpisTotal || kpisTotal === 0) return '0%';
            const impacto = (alertasMf / kpisTotal) * 1.0;
            return formatPercent(impacto, 2);
        }

        function atualizarKPIsPrincipais(periodo) {
            const data = getPeriodoData(periodo);
            if (!data) {
                console.warn(`Dados do período ${periodo} não encontrados.`);
                document.getElementById('kpiTotalAlertas').textContent = '0';
                document.getElementById('kpiMainframesCritico').textContent = '-';
                document.getElementById('kpiComponenteCritico').textContent = '-';
                document.getElementById('kpiDisponibilidade').textContent = '0%';
                return;
            }

            const kpis = data.kpis || {};
            const componentes = data.componentes || {};

            document.getElementById('kpiTotalAlertas').textContent = kpis.totalAlertas ?? '0';

            const breakdownEl = document.getElementById('kpiBreakdown');
            breakdownEl.innerHTML = `
                <span style="color:var(--perigo)">Muito Urgentes: ${kpis.muitoUrgentes ?? 0}</span>
                <span style="color:var(--very-urgent); margin-left:8px">Urgentes: ${kpis.urgentes ?? 0}</span>
                <span style="color:var(--accent-light); margin-left:8px">Emergências: ${kpis.emergencias ?? 0}</span>
            `;

            document.getElementById('kpiMainframesCritico').textContent = data._hostName || '-';

            const componenteMaior = kpis.componenteCritico || (
                (componentes.cpu && componentes.cpu.max >= (componentes.ram?.max||0) && componentes.cpu.max >= (componentes.disco?.max||0)) ? 'CPU' :
                (componentes.ram && componentes.ram.max >= (componentes.cpu?.max||0) && componentes.ram.max >= (componentes.disco?.max||0)) ? 'RAM' : 'DISCO'
            );

            document.getElementById('kpiComponenteCritico').textContent =
                `${componenteMaior} — pico: ${kpis.picoCpu ?? '-'}`;

            const disponibilidade = kpis.disponibilidade ?? 0;
            const kpiDisponibilidadeEl = document.getElementById('kpiDisponibilidade');
            kpiDisponibilidadeEl.textContent = disponibilidade + '%';

            const badgeEl = document.getElementById('kpiSlaBadge');
            const diff = (disponibilidade - SLA_CONTRATADO);
            if (diff >= 0) {
                badgeEl.style.display = 'inline-block';
                badgeEl.style.background = 'linear-gradient(90deg, var(--sucesso), #0f9d45)';
                badgeEl.style.color = 'white';
                badgeEl.textContent = `SLA OK (+${diff.toFixed(2)}%)`;
            } else {
                badgeEl.style.display = 'inline-block';
                badgeEl.style.background = 'linear-gradient(90deg, var(--perigo), var(--very-urgent))';
                badgeEl.style.color = 'white';
                badgeEl.textContent = `Fora do SLA (${diff.toFixed(2)}%)`;
            }

            if (data.rto && typeof data.rto.estimadoMinutos !== 'undefined') {
                const target = minutesToHuman(data.rto.estimadoMinutos);
                document.getElementById('kpiPico').textContent = `RTO estimado: ${target}`;
            }
        }

        function inicializarGraficoMainframes() {
            const canvas = document.getElementById('graficoMainframes');
            if (!canvas) return;
            if (window.chartMainframes) window.chartMainframes.destroy();

            const raw = window.dashboardData && window.dashboardData[periodoAtual];
            if (!raw) return;
            const labels = Object.keys(raw || {});
            const values = labels.map(name => (raw[name]?.kpis?.totalAlertas) ?? 0);

            const colors = values.map(v => v > 50 ? '#ef4444' : (v > 10 ? '#f97316' : '#22c55e'));

            const ctx = canvas.getContext('2d');
            window.chartMainframes = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Alertas (Total)', data: values, backgroundColor: colors, borderRadius: 8 }] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.03)' } },
                        y: { ticks: { color: '#cbd5e1' }, grid: { display: false } }
                    }
                }
            });
        }

        function inicializarGraficoComponentes() {
            if (!['all', 'alta', 'media', 'baixa'].includes(tempoFiltro)) tempoFiltro = 'all';

            const canvas = document.getElementById('graficoComponentes');
            if (!canvas) return;
            if (window.chartComponentes) window.chartComponentes.destroy();

            const data = getPeriodoData(periodoAtual);
            if (!data) return;

            const tempo = data.tempoSolucao || {};

            let labels, atualValues, targetValues;
            if (tempoFiltro === 'all') {
                labels = ['Alta', 'Média', 'Baixa'];
                atualValues = [
                    tempo.alta?.atualMinutes ?? 0,
                    tempo.media?.atualMinutes ?? 0,
                    tempo.baixa?.atualMinutes ?? 0
                ];
                // targets: usar do JSON se existir, senão usar mockado
                targetValues = [
                    tempo.alta?.targetMinutes ?? SLA_TARGETS.alta,
                    tempo.media?.targetMinutes ?? SLA_TARGETS.media,
                    tempo.baixa?.targetMinutes ?? SLA_TARGETS.baixa
                ];
            } else {
                const key = tempoFiltro;
                labels = [key.charAt(0).toUpperCase() + key.slice(1)];
                atualValues = [tempo[key]?.atualMinutes ?? 0];
                targetValues = [tempo[key]?.targetMinutes ?? SLA_TARGETS[key]];
            }

            const datasets = [
                {
                    label: 'SLA alvo (min)',
                    data: targetValues,
                    backgroundColor: 'rgba(99,102,241,0.6)',
                    borderRadius: 8
                },
                {
                    label: 'Tempo médio atual (min)',
                    data: atualValues,
                    backgroundColor: atualValues.map((v, i) => v <= targetValues[i] ? 'rgb(34,197,94)' : 'rgb(239,68,68)'),
                    borderRadius: 8
                }
            ];

            const ctx = canvas.getContext('2d');
            window.chartComponentes = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 14, weight: '700' },
                                boxWidth: 18,
                                boxHeight: 18,
                                padding: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const raw = context.raw;
                                    const label = context.dataset.label;
                                    const human = minutesToHuman(raw);
                                    return `${label}: ${human} (${raw} min)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.03)' } },
                        y: { ticks: { color: '#cbd5e1' }, grid: { display: false } }
                    }
                }
            });
        }

        function setFiltroTempo(filtro) {
            tempoFiltro = filtro;
            document.querySelectorAll('.filtro-btn').forEach(b =>
                b.classList.toggle('ativo', b.getAttribute('data-filtro') === filtro)
            );
            inicializarGraficoComponentes();
        }

        function atualizarDashboard(periodo) {
            periodoAtual = periodo;
            atualizarKPIsPrincipais(periodo);
            inicializarGraficoMainframes();
            inicializarGraficoComponentes();
        }

        window.onload = function () {
            if (typeof validarSessaoSynkro === 'function') validarSessaoSynkro();

            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', () => setFiltroTempo(btn.getAttribute('data-filtro')));
            });

            if (window.dashboardData && Object.keys(window.dashboardData).length > 0) {
                atualizarDashboard(periodoAtual);
            }
        };
    </script>
</body>

</html>