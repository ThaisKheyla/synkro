<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gerencial - Synkro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/historico.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoSynkro()">
    <div class="layout-principal">

        <aside class="barra-lateral">
            <div class="logo">
                Synkro
            </div>
            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão">
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Gerente de Infra
                </div>
                <div class="email-usuario" id="email_login">usuario.email@synkro.com</div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li>
                        <a href="dashboardGerente.html">
                            <i class="ri-dashboard-3-line"></i>
                            Visão Geral
                        </a>
                    </li>
                    <li>
                        <a href="visaoMainframesGerente.html">
                            <i class="ri-dashboard-3-line"></i>
                            Mainframes
                        </a>
                    </li>
                    <li>
                        <a href="historico.html" class="ativo">
                            <i class="ri-file-add-line icon-cadastro"></i>
                            Logs e Histórico
                        </a>
                    </li>
                    <li>
                        <a href="Funcionarios.html">
                            <i class="ri-database-2-line"></i>
                            Funcionários cadastrados
                        </a>
                    </li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()">
                    <i class="ri-logout-box-r-line"></i>
                    Encerrar Sessão
                </button>
            </nav>
        </aside>

        <main class="conteudo-principal">


            <header class="historico-header">
                <h1>Histórico de Eventos e Logs do Mainframe</h1>
                <p>Visualize indicadores-chave e a sequência cronológica de todos os eventos do sistema principal.</p>
            </header>

            <div class="dashboard-grid">

                <section class="visao-estrategica">
                    <div class="widget widget-alertas">

                        <div class="alerta-header-fixo">
                            <div class="btn-periodo-container">
                                <button class="btn-periodo" id="btnPeriodo">
                                    Última Semana <i class="ri-arrow-down-s-line"></i>
                                </button>
                                <ul class="dropdown-periodo" id="dropdownPeriodo">
                                    <li data-periodo="hoje">Hoje</li>
                                    <li data-periodo="semana">Última Semana</li>
                                    <li data-periodo="mes">Último Mês</li>
                                    <li data-periodo="ano">Último Ano</li>
                                </ul>
                            </div>
                            <h3>Histórico de Alertas (Logs Recentes)</h3>
                        </div>

                        <ul id="listaAlertas">
                        </ul>
                    </div>
                </section>

                <aside class="mainframes-cadastrados">

                    <div class="widget widget-grafico-pizza">
                        <h3>Distribuição Global de Alertas</h3>
                        <canvas id="pieChart" width="300" height="250"></canvas>
                    </div>

                    <!-- ('Aberto'),('Em andamento'),('Resolvido'); -->

                    <div class="widget widget-metrica-agregada">
                        <h3>Métricas do Período</h3>
                        <ul>
                        </ul>
                    </div>
                </aside>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dadosAlertas = [
                { id: 2, tempo: "04/11/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "hoje", cpu: 95 },
                { id: 5, tempo: "04/11/25 • 16:50", tag: "MFR-01", tipo: "critical", descricao: "Falha no monitoramento da CPU — Operações Críticas", status: "CRÍTICO", periodo: "hoje", cpu: 92 },
                { id: 3, tempo: "04/11/25 • 09:30", tag: "MFR-02", tipo: "critical", descricao: "Uso de CPU muito Alto — Operações Críticas", status: "CRÍTICO", periodo: "hoje", cpu: 75 },
                { id: 7, tempo: "04/11/25 • 11:15", tag: "MFR-02", tipo: "warning", descricao: "Pico de Latência — RAM", status: "URGENTE", periodo: "hoje", cpu: 80 },
                { id: 1, tempo: "04/11/25 • 10:00", tag: "MFR-03", tipo: "info", descricao: "Aviso de Disco — Armazenamento", status: "NORMAL", periodo: "hoje", cpu: 45 },
                { id: 4, tempo: "04/11/25 • 14:00", tag: "MFR-03", tipo: "info", descricao: "Disco com falha ", status: "NORMAL", periodo: "hoje", cpu: 55 },

                // ===================== SEMANA =====================
                { id: 9, tempo: "04/10/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "semana", cpu: 97 },
                { id: 12, tempo: "03/10/25 • 16:50", tag: "MFR-01", tipo: "critical", descricao: "Falha de Conexão DB — Base de Dados Principal", status: "URGENTE", periodo: "semana", cpu: 89 },
                { id: 10, tempo: "02/10/25 • 09:30", tag: "MFR-02", tipo: "warning", descricao: "Uso de Memória Alto — Análise Preditiva", status: "CRÍTICO", periodo: "semana", cpu: 78 },
                { id: 14, tempo: "01/10/25 • 11:15", tag: "MFR-02", tipo: "warning", descricao: "Pico de Latência — Rede Externa", status: "URGENTE", periodo: "semana", cpu: 82 },
                { id: 11, tempo: "30/09/25 • 14:00", tag: "MFR-03", tipo: "info", descricao: "Conexão de Rede Instável — Infra", status: "NORMAL", periodo: "semana", cpu: 51 },
                { id: 13, tempo: "29/09/25 • 08:00", tag: "MFR-04", tipo: "info", descricao: "Backup Concluído — Rotina Diária", status: "NORMAL", periodo: "semana", cpu: 33 },
                { id: 15, tempo: "28/09/25 • 10:30", tag: "MFR-01", tipo: "info", descricao: "Configuração Atualizada — Segurança", status: "NORMAL", periodo: "semana", cpu: 42 },

                // ===================== MÊS =====================
                { id: 17, tempo: "04/10/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "mes", cpu: 91 },
                { id: 20, tempo: "03/10/25 • 16:50", tag: "MFR-01", tipo: "critical", descricao: "Falha de Conexão DB — Base de Dados Principal", status: "URGENTE", periodo: "mes", cpu: 94 },
                { id: 25, tempo: "02/10/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "mes", cpu: 96 },
                { id: 28, tempo: "01/10/25 • 16:50", tag: "MFR-01", tipo: "critical", descricao: "Falha de Conexão DB — Base de Dados Principal", status: "URGENTE", periodo: "mes", cpu: 88 },
                { id: 18, tempo: "30/09/25 • 09:30", tag: "MFR-02", tipo: "warning", descricao: "Uso de Memória Alto — Análise Preditiva", status: "CRÍTICO", periodo: "mes", cpu: 70 },
                { id: 22, tempo: "29/09/25 • 11:15", tag: "MFR-02", tipo: "warning", descricao: "Pico de Latência — Rede Externa", status: "URGENTE", periodo: "mes", cpu: 74 },
                { id: 26, tempo: "28/09/25 • 09:30", tag: "MFR-02", tipo: "warning", descricao: "Uso de Memória Alto — Análise Preditiva", status: "CRÍTICO", periodo: "mes", cpu: 81 },
                { id: 30, tempo: "27/09/25 • 11:15", tag: "MFR-02", tipo: "warning", descricao: "Pico de Latência — Rede Externa", status: "URGENTE", periodo: "mes", cpu: 77 },
                { id: 16, tempo: "26/09/25 • 10:00", tag: "MFR-03", tipo: "info", descricao: "Aviso de Disco — Armazenamento", status: "NORMAL", periodo: "mes", cpu: 48 },
                { id: 19, tempo: "25/09/25 • 14:00", tag: "MFR-03", tipo: "info", descricao: "Conexão de Rede Instável — Infra", status: "NORMAL", periodo: "mes", cpu: 52 },
                { id: 21, tempo: "24/09/25 • 08:00", tag: "MFR-04", tipo: "info", descricao: "Backup Concluído — Rotina Diária", status: "NORMAL", periodo: "mes", cpu: 35 },
                { id: 23, tempo: "23/09/25 • 10:30", tag: "MFR-01", tipo: "info", descricao: "Configuração Atualizada — Segurança", status: "NORMAL", periodo: "mes", cpu: 41 },
                { id: 27, tempo: "22/09/25 • 14:00", tag: "MFR-03", tipo: "info", descricao: "Conexão de Rede Instável — Infra", status: "NORMAL", periodo: "mes", cpu: 54 },
                { id: 29, tempo: "21/09/25 • 08:00", tag: "MFR-04", tipo: "info", descricao: "Backup Concluído — Rotina Diária", status: "NORMAL", periodo: "mes", cpu: 32 },
                { id: 31, tempo: "20/09/25 • 10:30", tag: "MFR-01", tipo: "info", descricao: "Configuração Atualizada — Segurança", status: "NORMAL", periodo: "mes", cpu: 43 },
                { id: 32, tempo: "19/09/25 • 10:00", tag: "MFR-03", tipo: "info", descricao: "Aviso de Disco — Armazenamento", status: "NORMAL", periodo: "mes", cpu: 49 },

                // ===================== ANO =====================
                { id: 33, tempo: "04/10/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "ano", cpu: 98 },
                { id: 34, tempo: "03/10/25 • 16:50", tag: "MFR-01", tipo: "critical", descricao: "Falha de Conexão DB — Base de Dados Principal", status: "URGENTE", periodo: "ano", cpu: 90 },
                { id: 35, tempo: "02/10/25 • 12:12", tag: "MFR-01", tipo: "critical", descricao: "Alerta Crítico de CPU — Operações Críticas", status: "CRÍTICO", periodo: "ano", cpu: 93 },
                { id: 36, tempo: "01/10/25 • 09:30", tag: "MFR-02", tipo: "warning", descricao: "Uso de Memória Alto — Análise Preditiva", status: "CRÍTICO", periodo: "ano", cpu: 72 },
                { id: 37, tempo: "30/09/25 • 11:15", tag: "MFR-02", tipo: "warning", descricao: "Pico de Latência — Rede Externa", status: "URGENTE", periodo: "ano", cpu: 85 },
                { id: 38, tempo: "29/09/25 • 09:30", tag: "MFR-02", tipo: "warning", descricao: "Uso de Memória Alto — Análise Preditiva", status: "CRÍTICO", periodo: "ano", cpu: 79 },
                { id: 39, tempo: "28/09/25 • 10:00", tag: "MFR-03", tipo: "info", descricao: "Aviso de Disco — Armazenamento", status: "NORMAL", periodo: "ano", cpu: 50 },
                { id: 40, tempo: "27/09/25 • 14:00", tag: "MFR-03", tipo: "info", descricao: "Conexão de Rede Instável — Infra", status: "URGENTE", periodo: "ano", cpu: 56 },
                { id: 41, tempo: "26/09/25 • 08:00", tag: "MFR-04", tipo: "info", descricao: "Backup Concluído — Rotina Diária", status: "NORMAL", periodo: "ano", cpu: 36 },
                { id: 42, tempo: "25/09/25 • 10:30", tag: "MFR-01", tipo: "info", descricao: "Configuração Atualizada — Segurança", status: "NORMAL", periodo: "ano", cpu: 44 },
            ];

            const listaAlertas = document.getElementById('listaAlertas');
            const btnPeriodo = document.getElementById('btnPeriodo');
            const dropdownPeriodo = document.getElementById('dropdownPeriodo');
            const metricasUl = document.querySelector('.widget-metrica-agregada ul');
            const ctx = document.getElementById('pieChart').getContext('2d');
            const cores = ['#ef4444', '#f59e0b', '#38bdf8'];
            let pieChart;

            function getAlertasFiltrados(periodoSelecionado) {
                return dadosAlertas.filter(alerta => {
                    const periodoAlerta = alerta.periodo;
                    if (periodoSelecionado === 'hoje' && periodoAlerta === 'hoje') return true;
                    if (periodoSelecionado === 'semana' && (periodoAlerta === 'hoje' || periodoAlerta === 'semana')) return true;
                    if (periodoSelecionado === 'mes' && (periodoAlerta === 'hoje' || periodoAlerta === 'semana' || periodoAlerta === 'mes')) return true;
                    if (periodoSelecionado === 'ano' && (periodoAlerta === 'hoje' || periodoAlerta === 'semana' || periodoAlerta === 'mes' || periodoAlerta === 'ano')) return true;
                    return false;
                });
            }

            function renderizarAlertas(alertas) {
                listaAlertas.innerHTML = '';
                if (alertas.length === 0) {
                    listaAlertas.innerHTML = `<li style="padding: 15px; color: var(--cinza-texto); text-align: center;">Nenhum alerta encontrado para o período selecionado.</li>`;
                    return;
                }
                alertas.forEach(alerta => {
                    const li = document.createElement('li');
                    li.className = `alerta-item ${alerta.tipo}`;
                    const [titulo, subtitulo] = alerta.descricao.split('—').map(s => s.trim());
                    li.innerHTML = `
                    <span class="time">${alerta.tempo}</span>
                    <span class="tag">${alerta.tag}</span>
                    <span class="alerta-desc"><strong>${titulo}</strong> — ${subtitulo || ''}</span>
                    <span class="status">${alerta.status}</span>
                `;
                    listaAlertas.appendChild(li);
                });
            }

function calcularMetricas(alertas) {
    // Contagem por tipo (para o gráfico)
    const criticos = alertas.filter(a => a.tipo === 'critical').length;
    const warnings = alertas.filter(a => a.tipo === 'warning').length;
    const infos = alertas.filter(a => a.tipo === 'info').length;

    // Contagem por status (para o painel de métricas)
    const abertos = alertas.filter(a => a.status === 'CRÍTICO').length;
    const urgentes = alertas.filter(a => a.status === 'URGENTE').length;
    const normais = alertas.filter(a => a.status === 'NORMAL' || a.status === 'RESOLVIDO').length;

    // Total
    const totalAlertas = alertas.length;

    // Mainframe com maior uso de CPU
    const maxCpuAlerta = alertas.reduce((max, alerta) => {
        return alerta.cpu > max.cpu ? { tag: alerta.tag, cpu: alerta.cpu } : max;
    }, { tag: 'N/A', cpu: 0 });

    return {
        criticos,
        warnings,
        infos,
        totalAlertas,
        abertos,
        urgentes,
        normais,
        maxCpu: maxCpuAlerta
    };
}

function atualizarDashboard(alertas) {
    const metricas = calcularMetricas(alertas);

    // --- Atualizar Gráfico (Crítico, Urgente, Normal) ---
    const dadosGrafico = [metricas.criticos, metricas.warnings, metricas.infos];

    if (pieChart) {
        pieChart.data.datasets[0].data = dadosGrafico;
        pieChart.update();
    } else {
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Crítico', 'Urgente', 'Normal'],
                datasets: [{
                    data: dadosGrafico,
                    backgroundColor: cores,
                    hoverOffset: 8,
                    borderColor: '#1e293b',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#cbd5e1',
                            font: { size: 13, family: 'Inter', weight: 500 },
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#f8fafc',
                        bodyColor: '#cbd5e1',
                        borderColor: '#38bdf8',
                        borderWidth: 1,
                        cornerRadius: 6
                    }
                }
            }
        });
    }

    // --- Atualizar Métricas Agregadas (Painel à direita) ---
    metricasUl.innerHTML = `
        <li><strong>Total de alertas:</strong> ${metricas.totalAlertas}</li>
        <li><strong>Críticos:</strong> ${metricas.abertos}</li>
        <li><strong>Urgentes:</strong> ${metricas.urgentes}</li>
        <li><strong>Normais/Resolvidos:</strong> ${metricas.normais}</li>
        <li><strong>Mainframe mais ativo:</strong> ${metricas.maxCpu.tag} (${metricas.maxCpu.cpu}% CPU)</li>
    `;
}


            function inicializarFiltro(periodo) {
                const alertas = getAlertasFiltrados(periodo);
                renderizarAlertas(alertas);
                atualizarDashboard(alertas);
            }

            dropdownPeriodo.style.display = 'none';
            inicializarFiltro('semana');

            // Eventos do Dropdown
            btnPeriodo.addEventListener('click', (event) => {
                event.stopPropagation();
                dropdownPeriodo.style.display =
                    dropdownPeriodo.style.display === 'block' ? 'none' : 'block';
            });

            dropdownPeriodo.querySelectorAll('li').forEach(item => {
                item.addEventListener('click', () => {
                    const periodo = item.getAttribute('data-periodo');
                    btnPeriodo.innerHTML = item.innerText + ' <i class="ri-arrow-down-s-line"></i>';
                    dropdownPeriodo.style.display = 'none';
                    inicializarFiltro(periodo);
                });
            });

            document.addEventListener('click', (event) => {
                if (!dropdownPeriodo.contains(event.target) && event.target !== btnPeriodo) {
                    dropdownPeriodo.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>