<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Storage - Synkro</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/dashMainframes.css" />
    <link rel="stylesheet" href="./css/componentes/kpis.css" />
    <link rel="stylesheet" href="./css/componentes/status-cabecalho.css" />
    <link rel="stylesheet" href="./css/componentes/dashboards-storage.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="./js/sessao.js"></script>
</head>

<body onload="window.onload && window.onload()">
    <div class="layout-principal">
        <aside class="barra-lateral">
            <div class="logo">Synkro</div>

            <div class="perfil-usuario">
                <img src="./assets/imgs/userSynkro.webp" alt="Foto de perfil padrão" />
                <div class="nome-usuario" id="nome_login">Nome Sobrenome</div>
                <div class="cargo-usuario">
                    <i class="ri-shield-user-line"></i>
                    Analista
                </div>
                <div class="email-usuario" id="email_login">
                    usuario.email@synkro.com
                </div>
            </div>
            <nav>
                <ul class="menu-links">
                    <li>
                        <a href="dashboardAnalista.html">
                            <i class="ri-dashboard-3-line"></i>
                            Visão Geral
                        </a>
                    </li>
                    <li>
                        <a href="CadastroMainframe.html">
                            <i class="ri-file-add-line icon-cadastro"></i>
                            Cadastrar Mainframes
                        </a>
                    </li>
                    <li>
                        <a href="detalhesMainframe.html" class="ativo">
                            <i class="ri-database-2-line"></i>
                            Mainframes
                        </a>
                    </li>
                </ul>
                <button class="btn-sair" onclick="limparSessao()">
                    <i class="ri-logout-box-r-line"></i>
                    Encerrar Sessão
                </button>
            </nav>
        </aside>

        <main class="conteudo-dashboard">
            <div class="status-cabecalho">
                <div class="status-conteudo">
                    <div class="titulo-conteudo">
                        <i class="ri-pulse-line"></i>
                        <span>MONITORAMENTO DE ARMAZENAMENTO</span>
                    </div>
                    <div class="alertas-container">
                        <div class="alerta alerta-emergencia">
                            <i class="ri-alert-line"></i>
                            <span id="mainframe-alerta-nome">Mainframe 01:</span> MacAdress: <span
                                id="mainframe-alerta-mac">00:1B:44:11:3A:B7</span>
                        </div>
                    </div>
                    <div onclick="voltarParaMainframe()">></div>
                </div>
            </div>

            <!-- Lista de Mainframes -->
            <div class="mainframes-list" id="mainframes-cad">
            </div>

            <div class="dashboard-tabs">
                <button class="tab-btn ativo" onclick="mostrarDashboard('visao-geral')">
                    <i class="ri-dashboard-2-line"></i> Visão Geral <span id="mainfrane-title"></span>
                </button>
            </div>

            <div class="dashboard-content ativo" id="dashboard-visao-geral">
                <div class="titulo-descricao">
                    <p class="texto-descricao">
                        Dashboard em tempo real com métricas críticas de performance
                    </p>
                </div>


                <!-- layout -->
                <div class="layout">
                    <div class="div-principal">
                        <div class="indicador-saude">
                            <div class="texto">
                                <div class="titulo">Estado de Ocupação</div>
                                <div class="subtitulo">Capacidade total do disco</div>
                            </div>

                            <div class="alerta">
                                <i class="ri-alert-fill"></i>
                                <span>MUITO URGENTE</span>
                            </div>
                        </div>
                        
                        <!-- Métricas de Uso -->
                        <div class="metricas-uso">
                            <div class="bloco">
                                <div class="rotulo">Ocupado</div>
                                <div class="valor ocupado">78%</div>
                            </div>

                            <div class="divisor"></div>

                            <div class="bloco">
                                <div class="rotulo">Livre</div>
                                <div class="valor livre">22%</div>
                            </div>

                            <div class="divisor"></div>

                            <div class="bloco">
                                <div class="rotulo">Total</div>
                                <div class="valor total">100%</div>
                            </div>
                        </div>


                        <!-- Chart -->
                        <div class="grafico-espaco">
                            <canvas id="espacoChart"></canvas>
                        </div>

                    </div>

                    <!-- KPI limite critico -->
                    <div class="limite-critico">
                        <div class="decoracao"></div>
                        <div class="cabecalho">
                            <div>
                                <div class="titulo">Limite Crítico</div>
                                <div class="dias">~18d</div>
                            </div>
                            <div class="urgencia">
                                <div class="icone">
                                    <i class="ri-time-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="conteudo">
                            <div class="descricao">Estimativa para o nível máximo de ocupação</div>
                        </div>
                    </div>

                    <!-- Métrica 2: Taxa de crescimento/dia -->
                    <div class="taxa-diaria">
                        <div class="decoracao"></div>
                        <div class="cabecalho">
                            <div>
                                <div class="titulo">Taxa Diária</div>
                                <div class="valor">+15%</div>
                            </div>
                            <div class="urgencia">
                                <div class="icone">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                        stroke="rgba(99,102,241,1)" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                        <polyline points="5 12 12 5 19 12"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="conteudo">
                            <div class="acao">
                                <i class="ri-arrow-right-line"></i>Crescimento médio diário com base no dia anterior
                            </div>
                        </div>
                    </div>


                    <!-- Métrica: Crescimento histórico (30 dias) -->
                    <div class="crescimento-historico">
                        <div class="decoracao"></div>
                        <div class="cabecalho">
                            <div>
                                <div class="titulo">Ocupação a cada 1 minutos</div>
                            </div>
                            <div class="resumos">

                                <div class="resumo">
                                    <div class="resumo-label">Pico atual</div>
                                    <div class="resumo-valor">74.2%</div>
                                </div>
                            </div>
                        </div>
                        <div class="grafico">
                            <canvas id="growthTrendLine"></canvas>
                        </div>
                    </div>

                    <!-- Métrica 3: Latência -->
                    <div class="latencia">
                        <div class="decoracao"></div>
                        <div class="cabecalho">
                            <div>
                                <div class="titulo">Latência</div>
                                <div class="valor">18.5ms</div>
                            </div>
                            <div class="status">
                                <div class="icone">
                                    <i class="ri-timer-flash-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="conteudo">
                            <div class="acao">
                                <i class="ri-check-line"></i>Valor máximo registrado • Crítico &gt;25ms
                            </div>
                        </div>
                    </div>


                    <!-- Métrica 4: IOPS -->
                    <div class="iops">
                        <div class="decoracao"></div>
                        <div class="cabecalho">
                            <div>
                                <div class="titulo">IOPS Pico</div>
                                <div class="valor">4.2K</div>
                            </div>
                            <div class="status">
                                <div class="icone">
                                    <i class="ri-speed-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="conteudo">
                            <div class="acao">
                                <i class="ri-arrow-right-line"></i>Operações I/O por minuto • Capacidade ótima
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="./js/dashboards-storage.js"></script>
    <script src="./js/detalhesArmazenamento.js"></script>
</body>
<script>
    let armazenamentoDados = {};
    let mainframeAtualId = 0;
    let espacoChart = null;
    let growthChart = null;
    let updateInterval = null;

    // ===== COLORS =====
    const primaryColor = "rgba(124, 58, 237, 1)";
    const secondaryColor = "rgba(16, 185, 129, 1)";
    const tertiaryColor = "rgba(99, 102, 241, 1)";
    const accentColor = "rgba(236, 72, 153, 1)";
    const grayColor = "rgba(255, 255, 255, 0.04)";
    const fontColor = "rgba(226, 232, 240, 0.95)";
    const gridColor = "rgba(255, 255, 255, 0.06)";

    const tooltipOptions = {
        backgroundColor: "rgba(6, 10, 18, 0.95)",
        titleColor: fontColor,
        bodyColor: fontColor,
        borderColor: "rgba(255, 255, 255, 0.1)",
        borderWidth: 1,
        cornerRadius: 8,
        padding: 12,
    };

    // ===== BUSCAR DADOS DO JSON =====
    async function buscarJsonArmazenamento() {
        try {
            const resposta = await fetch(`/s3Route/dados/detalhesArmazenamento.json`);
            const data = await resposta.json();
            console.log("Dados de Armazenamento (completo):", data);

            let empresaId = sessionStorage.ID_EMPRESA_USUARIO;
            let mainframeMac = sessionStorage.getItem('MAINFRAME_MAC');
            let mainframeNome = sessionStorage.getItem('MAINFRAME_NOME');

            if (empresaId !== undefined && empresaId !== null) {
                const n = Number(empresaId);
                if (!Number.isNaN(n)) empresaId = n;
            }

            // Buscar empresa no array consolidado
            let empresa = null;
            if (data.empresas && Array.isArray(data.empresas)) {
                empresa = data.empresas.find(item => item.empresa == empresaId);
                if (!empresa) {
                    console.warn(`Empresa ${empresaId} não encontrada. Usando primeira empresa.`);
                    empresa = data.empresas[0];
                }
            }

            if (!empresa || !Array.isArray(empresa.mainframes)) {
                console.error('Estrutura de dados inválida em detalhesArmazenamento.json');
                return false;
            }

            console.log(`Empresa encontrada: ${empresa.empresa} | Total de mainframes: ${empresa.mainframes.length}`);

            // Se houver MAC selecionado, filtrar apenas esse mainframe
            if (mainframeMac) {
                const mainframeEncontrado = empresa.mainframes.find(mf => mf.mac === mainframeMac);
                if (mainframeEncontrado) {
                    armazenamentoDados = [mainframeEncontrado];
                    console.log(`Filtrando por MAC: ${mainframeMac}. Mainframe encontrado:`, mainframeEncontrado);
                    if (mainframeNome) {
                        document.getElementById("mainfrane-title").innerText = mainframeNome;
                    }
                } else {
                    console.warn(`MAC ${mainframeMac} não encontrado. Exibindo todos os mainframes da empresa.`);
                    armazenamentoDados = empresa.mainframes.slice();
                }
            } else {
                armazenamentoDados = empresa.mainframes.slice();
            }

            console.log("Dados carregados para exibição:", armazenamentoDados);
            return true;
        } catch (error) {
            console.error("Erro ao buscar dados de armazenamento:", error);
            return false;
        }
    }

    function renderMainframesList() {
        const container = document.getElementById("mainframes-cad");
        container.innerHTML = "";

        // Se houver apenas 1 mainframe (veio de detalhesMainframe), não mostrar lista
        if (armazenamentoDados.length === 1 && sessionStorage.getItem('MAINFRAME_MAC')) {
            container.style.display = "none";
            return;
        }

        container.style.display = "block";

        armazenamentoDados.forEach((mf, idx) => {
            const nomeDisplay = `${mf.fabricante} ${mf.modelo}`;
            container.innerHTML += `
                <a href="#" onclick="carregarDetalhesMainframe(${idx}); return false;">
                    <div id="mainF${idx}" class="mainframe-evento" style="
                        padding: 12px 16px;
                        background: rgba(99, 102, 241, 0.1);
                        border: 2px solid rgba(99, 102, 241, 0.3);
                        border-radius: 8px;
                        cursor: pointer;
                        white-space: nowrap;
                        transition: all 0.3s;
                    ">
                        <div style="font-weight: 600; color: rgba(226, 232, 240, 0.9);">${(idx + 1)}</div>
                        <div style="font-size: 12px; color: rgba(226, 232, 240, 0.6);">${nomeDisplay}</div>
                    </div>
                </a>
            `;
        });
    }

    // ===== CARREGAR DETALHES DE UM MAINFRAME =====
    function carregarDetalhesMainframe(id) {
        mainframeAtualId = id;

        // Atualizar estado visual
        armazenamentoDados.forEach((mf, idx) => {
            const element = document.getElementById(`mainF${idx}`);
            if (element) {
                if (idx == id) {
                    element.classList.add("clicked");
                    element.style.borderColor = "rgba(99, 102, 241, 1)";
                    element.style.background = "rgba(99, 102, 241, 0.2)";
                } else {
                    element.classList.remove("clicked");
                    element.style.borderColor = "rgba(99, 102, 241, 0.3)";
                    element.style.background = "rgba(99, 102, 241, 0.1)";
                }
            }
        });

        atualizarGraficosComDados(id);
    }

    // ===== ATUALIZAR GRÁFICOS E MÉTRICAS =====
    function atualizarGraficosComDados(id) {
        const dados = armazenamentoDados[id];
        
        console.log('jabiraca radical' + armazenamentoDados[0] + armazenamentoDados[1]);

        const nomeMainframe = `${dados.fabricante} ${dados.modelo}`;

        document.getElementById("mainfrane-title").innerText = nomeMainframe;
        document.getElementById("mainframe-alerta-nome").innerText = `${nomeMainframe}:`;
        document.getElementById("mainframe-alerta-mac").innerText = dados.mac;

        document.querySelector(".indicador-saude .titulo").textContent = `Estado de Ocupação (${dados.mac})`;
        document.querySelector(".metricas-uso .bloco:nth-child(1) .valor").textContent = dados.uso_disco_percentual + "%";
        document.querySelector(".metricas-uso .bloco:nth-child(3) .valor").textContent = (100 - dados.uso_disco_percentual) + "%";

        const diasAte95 = dados.dias_ate_95pct ? dados.dias_ate_95pct.toFixed(0) : "N/A";
        const crescDiario = dados.crescimento_diario_pct ? dados.crescimento_diario_pct.toFixed(2) : "0.00";

        document.querySelector(".limite-critico .dias").textContent = `~${diasAte95}d`;
        document.querySelector(".taxa-diaria .valor").textContent = `+${crescDiario}%`;
        document.querySelector(".latencia .valor").textContent = `${dados.latencia_ms.toFixed(1)}ms`;
        document.querySelector(".iops .valor").textContent = `${(dados.pico_iops / 1000).toFixed(1)}K`;

        const picoAtual = Math.max(...dados.historico_disco);
        document.querySelector(".resumo-valor").textContent = picoAtual.toFixed(1) + "%";

        if (espacoChart) espacoChart.destroy();
        if (growthChart) growthChart.destroy();

        criarGraficoEspaco(dados);
        criarGraficoCrescimento(dados);
    }

    // ===== CRIAR GRÁFICO DE ESPAÇO =====
    function criarGraficoEspaco(dados) {
        const espacoCtx = document.getElementById("espacoChart");
        if (!espacoCtx) return;

        const ctx = espacoCtx.getContext("2d");
        const percentualLivre = 100 - dados.uso_disco_percentual;
        
        espacoChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Uso"],
                datasets: [
                    {
                        label: "Ocupado (%)",
                        data: [dados.uso_disco_percentual],
                        backgroundColor: "rgba(245, 158, 11, 0.8)",
                        borderColor: "rgba(245, 158, 11, 0.6)",
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                        barPercentage: 1.0,
                        categoryPercentage: 0.7,
                    },
                    {
                        label: "Disponível (%)",
                        data: [percentualLivre],
                        backgroundColor: "rgba(16, 185, 129, 0.8)",
                        borderColor: "rgba(16, 185, 129, 0.6)",
                        borderWidth: 1.5,
                        borderRadius: 6,
                        borderSkipped: false,
                        barPercentage: 1.0,
                        categoryPercentage: 0.7,
                    },
                ],
            },
            options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        max: 100,
                        grid: { color: "rgba(236, 72, 153, 0.06)", drawBorder: false },
                        ticks: {
                            color: "rgba(226,232,240,0.7)",
                            font: { size: 10, weight: "600" },
                            callback: function (value) {
                                return value + "%";
                            },
                        },
                    },
                    y: {
                        grid: { display: false, drawBorder: false },
                        ticks: {
                            color: "rgba(226,232,240,0.7)",
                            font: { size: 11, weight: "600" },
                        },
                    },
                },
                plugins: {
                    legend: {
                        position: "top",
                        labels: {
                            color: "rgba(226,232,240,0.8)",
                            font: { size: 11, weight: "600" },
                            padding: 12,
                            usePointStyle: true,
                            pointStyle: "circle",
                        },
                    },
                    tooltip: Object.assign({}, tooltipOptions, {
                        callbacks: {
                            label: function (context) {
                                return (
                                    context.dataset.label +
                                    ": " +
                                    (context.parsed.x || 0).toFixed(1) +
                                    "%"
                                );
                            },
                        },
                    }),
                },
            },
        });
    }

    // ===== CRIAR GRÁFICO DE CRESCIMENTO =====
    function criarGraficoCrescimento(dados) {
        const growthTrendCtx = document.getElementById("growthTrendLine");
        if (!growthTrendCtx) return;

        const ctx = growthTrendCtx.getContext("2d");
        const gradient = ctx.createLinearGradient(0, 0, 0, growthTrendCtx.height || 200);
        gradient.addColorStop(0, "rgba(99, 102, 241, 0.4)");
        gradient.addColorStop(0.5, "rgba(99, 102, 241, 0.15)");
        gradient.addColorStop(1, "rgba(99, 102, 241, 0.01)");

        // Gerar labels para o histórico (timestamps ou minutos atrás)
        const labels = dados.historico_datas && dados.historico_datas.length > 0
            ? dados.historico_datas.map(d => d.split(' ')[1] || d)
            : Array.from({ length: dados.historico_disco.length }, (_, i) => `${(i * 5)}min`);

        growthChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Ocupação (%)",
                        data: dados.historico_disco,
                        borderColor: "rgba(99, 102, 241, 1)",
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.45,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: "rgba(6, 10, 18, 1)",
                        pointBorderWidth: 2.5,
                        pointBorderColor: "rgba(99, 102, 241, 1)",
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "nearest", intersect: false },
                scales: {
                    x: {
                        grid: {
                            color: "rgba(99, 102, 241, 0.08)",
                            drawBorder: false,
                            drawTicks: false,
                        },
                        ticks: {
                            color: "rgba(226,232,240,0.6)",
                            font: { size: 10, weight: "600" },
                        },
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: {
                            color: "rgba(99, 102, 241, 0.06)",
                            borderDash: [6, 4],
                            drawBorder: false,
                        },
                        ticks: {
                            color: "rgba(226,232,240,0.6)",
                            font: { size: 10, weight: "600" },
                            callback: function (value) {
                                return value + "%";
                            },
                            padding: 8,
                        },
                    },
                },
                plugins: {
                    legend: { display: false },
                    tooltip: Object.assign({}, tooltipOptions, {
                        callbacks: {
                            label: function (context) {
                                return (context.parsed.y || 0).toFixed(1) + " %";
                            },
                        },
                    }),
                },
            },
        });
    }

    function voltarParaMainframe() {
        sessionStorage.removeItem('MAINFRAME_MAC');
        sessionStorage.removeItem('MAINFRAME_NOME');
        window.location.href = 'detalhesMainframe.html';
    }

    function atualizarDadosPeriodicamente() {
        updateInterval = setInterval(() => {
            atualizarGraficosComDados(mainframeAtualId);
        }, 3000); // A cada 3 segundos
    }

    // ===== CARREGAR DADOS NA INICIALIZAÇÃO =====
    window.onload = () => {
        validarSessaoSynkro();
        buscarJsonArmazenamento().then((sucesso) => {
            if (sucesso) {
                renderMainframesList();
                carregarDetalhesMainframe(mainframeAtualId);
                atualizarDadosPeriodicamente();
            }
        });
    };

    // ===== PROJECTION LINE (Projeção próximos 30 dias) - Enhanced =====
    const projectionCtx = document.getElementById("projectionLine");
    if (projectionCtx) {
        const ctx = projectionCtx.getContext("2d");
        const gradientProj = ctx.createLinearGradient(
            0,
            0,
            0,
            projectionCtx.height || 200
        );
        gradientProj.addColorStop(0, "rgba(245, 158, 11, 0.4)");
        gradientProj.addColorStop(0.5, "rgba(245, 158, 11, 0.15)");
        gradientProj.addColorStop(1, "rgba(245, 158, 11, 0.01)");

        new Chart(ctx, {
            type: "line",
            data: {
                labels: ["Hoje", "D+5", "D+10", "D+15", "D+20", "D+25", "D+30"],
                datasets: [
                    {
                        label: "Projeção (TB)",
                        data: [14.2, 14.4, 14.6, 14.8, 15.0, 15.2, 15.4],
                        borderColor: "rgba(245, 158, 11, 1)",
                        backgroundColor: gradientProj,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.45,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: "rgba(6, 10, 18, 1)",
                        pointBorderWidth: 2.5,
                        pointBorderColor: "rgba(245, 158, 11, 1)",
                        borderDash: [6, 3],
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "nearest", intersect: false },
                scales: {
                    x: {
                        grid: {
                            color: "rgba(245, 158, 11, 0.08)",
                            drawBorder: false,
                            drawTicks: false,
                        },
                        ticks: {
                            color: "rgba(226,232,240,0.6)",
                            font: { size: 10, weight: "600" },
                        },
                    },
                    y: {
                        min: 13.5,
                        max: 18,
                        grid: {
                            color: "rgba(245, 158, 11, 0.06)",
                            borderDash: [6, 4],
                            drawBorder: false,
                        },
                        ticks: {
                            color: "rgba(226,232,240,0.6)",
                            font: { size: 10, weight: "600" },
                            callback: function (value) {
                                return value + " TB";
                            },
                            padding: 8,
                        },
                    },
                },
                plugins: {
                    legend: { display: false },
                    tooltip: Object.assign({}, tooltipOptions, {
                        callbacks: {
                            label: function (context) {
                                return (
                                    "Projeção: " + (context.parsed.y || 0).toFixed(1) + " TB"
                                );
                            },
                        },
                    }),
                },
            },
        });
    }
</script>

</html>